---
title: "12 Malware Analysis - Forensic McBlue to the REVscue!"
date: 2022-12-14
tags:
- writeups
---

## Story
The malicious document attached to the phishing email was confirmed to have been executed. Aside from the fact that rogue connections were observed, we know little about what it does.

Our in-house expert **Forensic McBlue** confirmed that the malicious document spawned another suspicious binary. Pivoting from that, he dumped it from memory for this task to be further analysed via Malware Analysis.

### Learning Objectives
- Learn the fundamentals of analysing malware samples without relying on automated sandbox scanners.
- Learn and understand typical malware behaviour and its importance in the incident investigation pipeline.

## Notes 

### Dangers of Analysing Malware Samples

> **Warning**: handling a malware sample is dangerous. Always consider precautions while analysing it

- always assume that samples will infect your device even if you consider yourself a "specialist"
- executing it is not always the 1st & only step in analysing it *(i.e static analysis)*
- only run the sample in a controlled environment that prevents potential further compromise of unwanted assets
- always have a sandbox in the pocket, such as a VM which allows you to worry less & analyze more
	- a controlled test environment that mimics a legitimate end-user working environment
	- prevents the impractical possibility of unwanted impact upon compromise
	- usually have a wide-range of tools for static/dynamic analysis
- **Web-based SandBox Solutions**
	- [any.run](https://any.run/)
	- [Hybrid Analysis](https://www.hybrid-analysis.com/)


### Static Analysis
Ways of analysing a malware sample without executing the code such as profiling the binary with its readable information, such as its properties, program flow and strings. Given the limitation of not executing it, sometimes this method gives insufficient information, which is why we have [[Dynamic Analysis]]

- **Tools**
	- [DetectItEasy](https://github.com/horsicq/Detect-It-Easy)
	- [UPX](https://upx.github.io/)
	- [capa](https://github.com/mandiant/capa)
	- [[write-ups/thm/sysinternals]]

### Dynamic Analysis
Mainly focuses on understanding the malware by executing it in a safe environment, such as a Sandbox. Thus you're able to see it live in action, its exact behaviour, and how it infects the environment

## Practical
We are given a [FlareVM](https://github.com/mandiant/flare-vm) which contains the sample & any other tools we might need. We can access it via RDP once we're connected to the VPN with a client *(i.e `xfreerdp`)*

![[write-ups/images/Pasted image 20221215022852.png]]

### Static Analysis
Going into the `Malware Sample` folder we find our pacient `mysterygift.exe`. Let's try doing 1st some [[Static Analysis]] before executing it. We can start using `strings` & a vast amount of tools when it comes to this, but I decided to open it with [Detect It Easy](https://github.com/horsicq/Detect-It-Easy) since that's what the challenge recommends: 

![[write-ups/images/Pasted image 20221215023612.png]]

We can see that it's a 64-bit [[PE File]] which seems to use the [UPX](https://github.com/upx/upx) [[packer]] which is an advanced executable file compressor: reduces the file size of programs and DLLs by around 50%-70%. This becomes quite in handy for attackers since they can make their malware less computional heavy *(e.g reduce disk space, network load times, download times)* & harder to detect by AV vendors during static analysis *(especially if a [[crypter]] or other obfuscation methods are used)*.

Now that we know the packer used we can extract it:

![[write-ups/images/Pasted image 20221215024558.png]]

Re-examining it now with the use of [capa](https://github.com/mandiant/capa): an awesome tool used to detect capabilities in executable files *(can be ran on [[PE File|PE]], [[ELF]], `.NET` modules even shellcode files)*. Actions & images speak much better than words so let's have a look by running: `capa .\mysterygift`

![[write-ups/images/Pasted image 20221215025123.png]]

We get quite a generous output giving us some potential [[sheets/Indicators of Compromise (IOCs)]] such as hashes, which we can verify on [virustotal](https://www.virustotal.com/gui/file/647458e71aea13d92e944bc7b7f305c6da808c71c3d19dc255a96dd60c8800a7) to gain more insight, we get what [[Mitre ATT&CK]] tactics, procedures & techniques it uses, see the compiller *(i.e [Nim](https://github.com/adamsvoboda/nim-loader/))* & learn about its functionality.


### Dynamic Analysis
Now that we know more about its functionality, it's time to detonate it & take a look at its behaviour with the [[write-ups/thm/sysinternals|sysinternals]] suite. Open up `Process Monitor` & set `Process Name - is - mysterygift.exe`, click `Ok`

![[write-ups/images/Pasted image 20221215033507.png]]

> **Note**: we can filter what activity we want to capture from the highlighted blue icons


#### Registry Modification & Persistence
I wanted to take a look @ what registry modifications it makes since that's where persistance is usually done. After excluding all the other operations except `ReqCreateKey` & `ReqSetValue` *(more info in the [docs](https://learn.microsoft.com/en-us/windows/win32/sysinfo/registry-functions))* I got this

![[write-ups/images/Pasted image 20221215035048.png]]

There's our little backdoor, where both `RegCreateKey` & `RegSetValue` are present. It accesses the [Run & RunOnce registry keys](https://learn.microsoft.com/en-us/windows/win32/setupapi/run-and-runonce-registry-keys) & executes a batch script called `wishes.bat`. This is a [known technique](https://attack.mitre.org/techniques/T1547/001/) of setting up persistance because will cause the program referenced to be executed when a user logs in

![[Pasted image 20221215035603.png]]

Following the rabbit hole & going to the folder from which it executed we find 2 files: 

```batch
:: setup.bat

@echo off
echo 127.0.0.1 localhost >> C:\Windows\System32\drivers\etc\hosts

for /f "tokens=3 delims=: " %%i  in ('netsh interface ip show config name^="Ethernet" ^| findstr "IP Address"') do echo %%i virustotal.com >> C:\Windows\System32\drivers\etc\hosts

for /f "tokens=3 delims=: " %%i  in ('netsh interface ip show config name^="Npcap Loopback Adapter" ^| findstr "IP Address"') do echo %%i bestfestivalcompany.thm >> C:\Windows\System32\drivers\etc\hosts
```

![[Pasted image 20221215040656.png]]

More on that later

#### Writing to disk
Maybe `wishes.bat` has been created by our malware, if so in what other ways did it touch the disk? We can further investigate that by doing something similar as before   for the registry: with filters. 



## Refs
- [FlareVM](https://github.com/mandiant/flare-vm)
- [Official Walkthrough](https://www.youtube.com/watch?v=kdQZPLRnr3g)
- [nim-loader](https://github.com/adamsvoboda/nim-loader/)
- [virustotal scan](https://www.virustotal.com/gui/file/647458e71aea13d92e944bc7b7f305c6da808c71c3d19dc255a96dd60c8800a7/details)

## See Also
- [[write-ups/thm/Advent of Cyber 2022]]
- [[write-ups/thm/11 Memory Forensics - Not all gifts are nice]] | [[write-ups/thm/13 Packet Analysis - Simply having a wonderful pcap time]]
