<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Overview  most commonly used in conjuction w a security information & management system (SIEM) events are stored in Applications and Services Logs/Microsoft/Windows/Sysmon/Operational installation:  powersshell: Download-SysInternalsTools C:\Sysinternals Sysmon binary from the¬†Microsoft Sysinternals¬†website download the¬†Microsoft Sysinternal Suite staring it: Sysmon."><title>SysMon</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://hakbrain.xyz//icon.png><link href=https://hakbrain.xyz/styles.f40f9c8ac1c106641723dab5233fc67c.min.css rel=stylesheet><link href=https://hakbrain.xyz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://hakbrain.xyz/js/darkmode.8bfc78cc60cc5da6df81ec79c82c3775.min.js></script>
<script src=https://hakbrain.xyz/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://hakbrain.xyz/js/popover.abe6a51cc7138c5dff00f151dd627ad1.min.js></script>
<script src=https://hakbrain.xyz/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://hakbrain.xyz/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://hakbrain.xyz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://hakbrain.xyz/",fetchData=Promise.all([fetch("https://hakbrain.xyz/indices/linkIndex.9a01892b9427821b81e58f128fb19864.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://hakbrain.xyz/indices/contentIndex.ea921af160e84115f7c5eda47b9f6e92.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://hakbrain.xyz",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://hakbrain.xyz",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/hakbrain.xyz\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://hakbrain.xyz/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://hakbrain.xyz/>üï∏Ô∏è H@kBr4in</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>SysMon</h1><p class=meta>Last updated
Sep 6, 2022
<a href=https://github.com/vlagh3/hakbrain/tree/hugo/content/write-ups/thm/sysmon.md rel=noopener>Edit Source</a></p><ul class=tags><li><a href=https://hakbrain.xyz/tags/writeups/>Writeups</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#overview>Overview</a></li><li><a href=#cutting-out-the-noise>Cutting out the noise</a><ol><li><a href=#answers>Answers</a></li></ol></li><li><a href=#hunting-metasploit>Hunting Metasploit</a></li><li><a href=#detecting-mimikatzhttpsgithubcomparrotsecmimikatz>Detecting <a href=https://github.com/ParrotSec/mimikatz>Mimikatz</a></a></li><li><a href=#hunting-malware>Hunting Malware</a></li><li><a href=#hunting-persistence>Hunting Persistence</a><ol><li><a href=#startup>Startup</a></li><li><a href=#registry-key>Registry Key</a></li></ol></li><li><a href=#detecting-evasion-techniques>Detecting Evasion Techniques</a><ol><li><a href=#hunting-ads>Hunting ADS</a></li><li><a href=#detecting-remote-threads>Detecting Remote Threads</a></li><li><a href=#detecting-evasion-techniques-with-powershell>Detecting Evasion Techniques with PowerShell</a></li></ol></li><li><a href=#practical-investigations>Practical Investigations</a><ol><li><a href=#1---ugh-bill-thats-the-wrong-usb>1 - ugh, BILL THAT&rsquo;S THE WRONG USB!</a></li><li><a href=#2---this-isnt-an-html-file>2 - This isn&rsquo;t an HTML file?</a></li><li><a href=#31--32---wheres-the-bouncer-when-you-need-him>3.1 : 3.2 - Where&rsquo;s the bouncer when you need him</a></li></ol></li><li><a href=#references>References</a></li><li><a href=#see-also>See Also</a></li></ol></nav></details></aside><a href=#overview><h2 id=overview><span class=hanchor arialabel=Anchor># </span>Overview</h2></a><ul><li>most commonly used in conjuction w a security information & management system <em>(SIEM)</em></li><li>events are stored in <code>Applications and Services Logs/Microsoft/Windows/Sysmon/Operational</code></li><li>installation:<ul><li>powersshell: <code>Download-SysInternalsTools C:\Sysinternals</code></li><li>Sysmon binary from the¬†
<a href=https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon rel=noopener>Microsoft Sysinternals</a>¬†website</li><li>download the¬†
<a href=https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite rel=noopener>Microsoft Sysinternal Suite</a></li><li>staring it: <code>Sysmon.exe -accepteula -i sysmonconfig-export.xml</code></li></ul></li><li><a href=https://github.com/SwiftOnSecurity/sysmon-config rel=noopener>config example</a><ul><li>a majority of rules in sysmon-config will exclude events rather than include events</li></ul></li><li>Event ID 1: Process Creation<ul><li>will look for any processes that have been created<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;RuleGroup</span> <span class=na>name=</span><span class=s>&#34;&#34;</span> <span class=na>groupRelation=</span><span class=s>&#34;or&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;ProcessCreate</span> <span class=na>onmatch=</span><span class=s>&#34;exclude&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	  <span class=nt>&lt;CommandLine</span> <span class=na>condition=</span><span class=s>&#34;is&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>		C:\Windows\system32\svchost.exe -k appmodel -p -s camsvc
</span></span><span class=line><span class=cl>	  <span class=nt>&lt;/CommandLine&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/ProcessCreate&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;/RuleGroup&gt;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li><li>¬†exclude the <code>svchost.exe</code> process from the event logs</li></ul></li><li>Event ID 3: Network Connection<ul><li>¬†will look for events that occur remotely<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;RuleGroup</span> <span class=na>name=</span><span class=s>&#34;&#34;</span> <span class=na>groupRelation=</span><span class=s>&#34;or&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;NetworkConnect</span> <span class=na>onmatch=</span><span class=s>&#34;include&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	  <span class=nt>&lt;Image</span> <span class=na>condition=</span><span class=s>&#34;image&#34;</span><span class=nt>&gt;</span>nmap.exe<span class=nt>&lt;/Image&gt;</span>  
</span></span><span class=line><span class=cl>	  <span class=nt>&lt;DestinationPort</span> 
</span></span><span class=line><span class=cl>			<span class=na>name=</span><span class=s>&#34;Alert,Metasploit&#34;</span>
</span></span><span class=line><span class=cl>			<span class=na>condition=</span><span class=s>&#34;is&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>		  4444
</span></span><span class=line><span class=cl>	  <span class=nt>&lt;/DestinationPort&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/NetworkConnect&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;/RuleGroup&gt;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li></ul></li><li>Event ID 7: Image Loaded<ul><li>will look for¬†DLLs loaded by processes, which is useful when hunting for DLL Injection and DLL Hijacking attacks</li><li>exercise caution when using this Event ID as it causes a high system load<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;RuleGroup</span> <span class=na>name=</span><span class=s>&#34;&#34;</span> <span class=na>groupRelation=</span><span class=s>&#34;or&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;ImageLoad</span> <span class=na>onmatch=</span><span class=s>&#34;include&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	  <span class=nt>&lt;ImageLoaded</span> <span class=na>condition=</span><span class=s>&#34;contains&#34;</span><span class=nt>&gt;</span>\Temp\<span class=nt>&lt;/ImageLoaded&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/ImageLoad&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;/RuleGroup&gt;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li></ul></li><li>Event ID 8:
<a href=https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread rel=noopener>CreateRemoteThread</a><ul><li>will monitor for processes injecting code into other processes<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;RuleGroup</span> <span class=na>name=</span><span class=s>&#34;&#34;</span> <span class=na>groupRelation=</span><span class=s>&#34;or&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;CreateRemoteThread</span> <span class=na>onmatch=</span><span class=s>&#34;include&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	  <span class=nt>&lt;StartAddress</span> <span class=na>name=</span><span class=s>&#34;Alert,Cobalt Strike&#34;</span> <span class=na>condition=</span><span class=s>&#34;end with&#34;</span><span class=nt>&gt;</span>0B80<span class=nt>&lt;/StartAddress&gt;</span>  
</span></span><span class=line><span class=cl>	  <span class=nt>&lt;SourceImage</span> <span class=na>condition=</span><span class=s>&#34;contains&#34;</span><span class=nt>&gt;</span>\<span class=nt>&lt;/SourceImage&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/CreateRemoteThread&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;/RuleGroup&gt;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li><li>look at the memory address for a specific ending condition which could be an indicator of a Cobalt Strike beacon</li><li>look for injected processes that do not have a parent process</li></ul></li><li>Event ID 12 / 13 / 14: Registry Event<ul><li>looks for changes or modifications to the registry</li><li>malicious activity from the registry can include persistence and credential abuse<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;RuleGroup</span> <span class=na>name=</span><span class=s>&#34;&#34;</span> <span class=na>groupRelation=</span><span class=s>&#34;or&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;RegistryEvent</span> <span class=na>onmatch=</span><span class=s>&#34;include&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	  <span class=nt>&lt;TargetObject</span> <span class=na>name=</span><span class=s>&#34;T1484&#34;</span> <span class=na>condition=</span><span class=s>&#34;contains&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>		  Windows\System\Scripts
</span></span><span class=line><span class=cl>	  <span class=nt>&lt;/TargetObject&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/RegistryEvent&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;/RuleGroup&gt;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li></ul></li><li>Event ID 15:
<a href="https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=90015" rel=noopener>FileCreateStreamHash</a><ul><li>look for any files created in an alternate data stream</li><li>common technique used by adversaries to hide malware<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;RuleGroup</span> <span class=na>name=</span><span class=s>&#34;&#34;</span> <span class=na>groupRelation=</span><span class=s>&#34;or&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;FileCreateStreamHash</span> <span class=na>onmatch=</span><span class=s>&#34;include&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	  <span class=nt>&lt;TargetFilename</span> <span class=na>condition=</span><span class=s>&#34;end with&#34;</span><span class=nt>&gt;</span>.hta<span class=nt>&lt;/TargetFilename&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/FileCreateStreamHash&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;/RuleGroup&gt;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li><li>look for files with the <code>.hta</code> extension that have been placed within an alternate data stream</li></ul></li><li>Event ID 22: DNS Event<ul><li>log all¬†DNS¬†queries and events for analysis</li><li>most common way to deal with these events is to exclude all trusted domains that you know will be very common &ldquo;noise&rdquo; in your environment</li><li>once you get rid of the noise you can then look for DNS anomalies<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;RuleGroup</span> <span class=na>name=</span><span class=s>&#34;&#34;</span> <span class=na>groupRelation=</span><span class=s>&#34;or&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;DnsQuery</span> <span class=na>onmatch=</span><span class=s>&#34;exclude&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	  <span class=nt>&lt;QueryName</span> <span class=na>condition=</span><span class=s>&#34;end with&#34;</span><span class=nt>&gt;</span>.microsoft.com<span class=nt>&lt;/QueryName&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/DnsQuery&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;/RuleGroup&gt;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li><li>exclude any DNS events with the <code>.microsoft.com</code> query</li></ul></li></ul><a href=#cutting-out-the-noise><h2 id=cutting-out-the-noise><span class=hanchor arialabel=Anchor># </span>Cutting out the noise</h2></a><ul><li><strong>Exclude > Include</strong>: it&rsquo;s typically best to prioritize excluding events rather than including events. This prevents you from accidentally missing crucial events and only seeing the events that matter the most</li><li><strong>Use the CLI</strong>: gives you the most control and filtering allowing for further granular control. You can use either <code>Get-WinEvent</code> or <code>wevutil.exe</code> to access & filter logs <em>(see <a href=/write-ups/thm/windows-event-logs rel=noopener class=internal-link data-src=/write-ups/thm/windows-event-logs>write-ups/thm/windows-event-logs</a>)</em></li><li><strong>Know your env before implementation</strong>: should have a firm understanding of the network or environment you are working within to fully understand what is normal and what is suspicious in order to effectively craft your rules</li></ul><a href=#answers><h3 id=answers><span class=hanchor arialabel=Anchor># </span>Answers</h3></a><ul><li>How many event ID 3 events are in <code>C:\Users\THM-Analyst\Desktop\Scenarios\Practice\Filtering.evtx</code>?<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WinEvent</span> <span class=n>-Path</span> <span class=p>.\</span><span class=n>Filtering</span><span class=p>.</span><span class=n>evtx</span> <span class=n>-FilterXPath</span> <span class=s1>&#39;*/System/EventID=3&#39;</span> <span class=p>|</span> <span class=nb>Measure-Object</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Count</span>    <span class=err>:</span> <span class=n>73591</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li><li>What is the UTC time created of the first network event in¬†<code>C:\Users\THM-Analyst\Desktop\Scenarios\Practice\Filtering.evtx</code>?: <code>2021-01-06 01:35:50.464</code><ul><li>in Event Viewer: <code>Filter Current Log > EventID 3 > Sort by date & time</code></li></ul></li></ul><a href=#hunting-metasploit><h2 id=hunting-metasploit><span class=hanchor arialabel=Anchor># </span>Hunting Metasploit</h2></a><ul><li>how malware and payloads interact with the network check out the¬†
<a href=https://docs.google.com/spreadsheets/d/17pSTDNpa0sf6pHeRhusvWG6rThciE8CsXTSlDUAZDyo rel=noopener>Malware Common Ports Spreadsheet</a></li><li>detect the creation of new network connections: use <code>EventId=3</code> & active connections on <code>4444</code> & <code>5555</code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;RuleGroup</span> <span class=na>name=</span><span class=s>&#34;&#34;</span> <span class=na>groupRelation=</span><span class=s>&#34;or&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;NetworkConnect</span> <span class=na>onmatch=</span><span class=s>&#34;include&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;DestinationPort</span> <span class=na>condition=</span><span class=s>&#34;is&#34;</span><span class=nt>&gt;</span>4444<span class=nt>&lt;/DestinationPort&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;DestinationPort</span> <span class=na>condition=</span><span class=s>&#34;is&#34;</span><span class=nt>&gt;</span>5555<span class=nt>&lt;/DestinationPort&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/NetworkConnect&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;/RuleGroup&gt;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li><li>Using Powershell&rsquo;s
<a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.diagnostics/get-winevent?view=powershell-7.2" rel=noopener>Get-WinEvent</a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WinEvent</span> <span class=n>-Path</span> <span class=p>.\</span><span class=n>Hunting_Metasploit</span><span class=p>.</span><span class=n>evtx</span> <span class=n>-FilterXPath</span> <span class=s1>&#39;*/System/EventID=3 and */EventData/Data[@Name=&#34;DestinationPort&#34;] and */EventData/Data=4444&#39;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li></ul><h2 id=detecting-mimikatzhttpsgithubcomparrotsecmimikatz>Detecting
<a href=https://github.com/ParrotSec/mimikatz rel=noopener>Mimikatz</a></h2><ul><li>looking for files created with the name Mimikatz: simple way to detect activity that has bypassed anti-virus or other detection measures<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;RuleGroup</span> <span class=na>name=</span><span class=s>&#34;&#34;</span> <span class=na>groupRelation=</span><span class=s>&#34;or&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;FileCreate</span> <span class=na>onmatch=</span><span class=s>&#34;include&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;TargetFileName</span> <span class=na>condition=</span><span class=s>&#34;contains&#34;</span><span class=nt>&gt;</span>mimikatz<span class=nt>&lt;/TargetFileName&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/FileCreate&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;/RuleGroup&gt;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li></ul><blockquote><p><strong>NOTE:</strong> when dealing with an advanced threat you will need more advanced hunting techniques like searching for LSASS behavior but this technique can still be useful</p></blockquote><ul><li>abnormal <code>LSASS</code> behavior<ul><li>can use the¬†<code>ProcessAccess</code>¬†event ID</li><li>show potential LSASS abuse which usually connects back to Mimikatz some other kind of credential dumping tool</li><li>if LSASS is accessed by a process other than¬†<code>svchost.exe</code>¬†it should be considered suspicious</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;RuleGroup</span> <span class=na>name=</span><span class=s>&#34;&#34;</span> <span class=na>groupRelation=</span><span class=s>&#34;or&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;ProcessAccess</span> <span class=na>onmatch=</span><span class=s>&#34;exclude&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;SourceImage</span> <span class=na>condition=</span><span class=s>&#34;image&#34;</span><span class=nt>&gt;</span>svchost.exe<span class=nt>&lt;/SourceImage&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/ProcessAccess&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;ProcessAccess</span> <span class=na>onmatch=</span><span class=s>&#34;include&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;TargetImage</span> <span class=na>condition=</span><span class=s>&#34;image&#34;</span><span class=nt>&gt;</span>lsass.exe<span class=nt>&lt;/TargetImage&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/ProcessAccess&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;/RuleGroup&gt;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>or with powershell
</span></span><span class=line><span class=cl>`powershell
</span></span><span class=line><span class=cl>t-WinEvent -Path .\Hunting_Mimikatz.evtx -FilterXPath &#39;*/System/EventID=10 and */EventData/Data[@Name=&#34;TargetImage&#34;] and */EventData/Data=&#34;C:\Windows\system32\lsass.exe&#34;&#39; | Format-List
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li></ul><a href=#hunting-malware><h2 id=hunting-malware><span class=hanchor arialabel=Anchor># </span>Hunting Malware</h2></a><ul><li>RATs typically come with other Anti-Virus and detection evasion techniques<ul><li>also uses a Client-Server model and comes with an interface for easy user administration</li><li>examples:
<a href=https://github.com/jesusgavancho/Xeexe rel=noopener>Xeexe</a> &
<a href=https://github.com/quasar/Quasar rel=noopener>Quasar</a></li></ul></li><li>to detect and hunt malware we will need to first identify the malware that we want to hunt or detect and identify ways that we can modify configuration files, this is known as <strong>hypothesis-based hunting</strong></li><li>look through and create a configuration file to hunt and detect suspicious ports open on the endpoint</li><li>example from
<a href=https://github.com/ion-storm/sysmon-edr rel=noopener>Ion-Storm</a> which will alert specific ports <em>(i.e <code>1034</code> & <code>1604</code>)</em> as well ass exclude common network conn <em>(e.g OneDrive)</em><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;RuleGroup</span> <span class=na>name=</span><span class=s>&#34;&#34;</span> <span class=na>groupRelation=</span><span class=s>&#34;or&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;NetworkConnect</span> <span class=na>onmatch=</span><span class=s>&#34;include&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;DestinationPort</span> <span class=na>condition=</span><span class=s>&#34;is&#34;</span><span class=nt>&gt;</span>1034<span class=nt>&lt;/DestinationPort&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;DestinationPort</span> <span class=na>condition=</span><span class=s>&#34;is&#34;</span><span class=nt>&gt;</span>1604<span class=nt>&lt;/DestinationPort&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/NetworkConnect&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;NetworkConnect</span> <span class=na>onmatch=</span><span class=s>&#34;exclude&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;Image</span> <span class=na>condition=</span><span class=s>&#34;image&#34;</span><span class=nt>&gt;</span>OneDrive.exe<span class=nt>&lt;/Image&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/NetworkConnect&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;/RuleGroup&gt;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li></ul><blockquote><p><strong>NOTE</strong>: When using configuration files in a production env you need to understand exactly what is happening within the conf file. (e.g ¬†the Ion-Storm configuration file excludes port 53 as an event which adversaries have begun to usse as part of their payloads)</p></blockquote><ul><li>look for all <code>Network connection</code> events that have the destination port <code>8080</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WinEvent</span> <span class=n>-Path</span> <span class=p>.\</span><span class=n>Hunting_Rats</span><span class=p>.</span><span class=n>evtx</span> <span class=n>-FilterXPath</span> <span class=s1>&#39;*/System/EventID=3 and */EventData/Data[@Name=&#34;DestinationPort&#34;] and */EventData/Data=8080&#39;</span> <span class=p>|</span><span class=nb>Format-List</span>
</span></span></code></pre></td></tr></table></div></div><a href=#hunting-persistence><h2 id=hunting-persistence><span class=hanchor arialabel=Anchor># </span>Hunting Persistence</h2></a><ul><li>persistence is used by attackers to maintain access to a machine once it is compromised</li><li>there&rsquo;s multiple ways an attacker can achieve this, but we will focus on
<a href=https://attack.mitre.org/techniques/T1112/ rel=noopener>registry modification</a> &
<a href=https://attack.mitre.org/techniques/T1547/ rel=noopener>startup scripts</a> <em>(i.e File Creation events as well as Registry Modification events)</em></li></ul><a href=#startup><h3 id=startup><span class=hanchor arialabel=Anchor># </span>Startup</h3></a><ul><li>SwiftOnSecurity detections for a file being placed in the¬†<code>\Startup\</code>¬†or¬†<code>\Start Menu</code>¬†directories.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;RuleGroup</span> <span class=na>name=</span><span class=s>&#34;&#34;</span> <span class=na>groupRelation=</span><span class=s>&#34;or&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;FileCreate</span> <span class=na>onmatch=</span><span class=s>&#34;include&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;TargetFilename</span> <span class=na>name=</span><span class=s>&#34;T1023&#34;</span> <span class=na>condition=</span><span class=s>&#34;contains&#34;</span><span class=nt>&gt;</span>\Start Menu<span class=nt>&lt;/TargetFilename&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;TargetFilename</span> <span class=na>name=</span><span class=s>&#34;T1165&#34;</span> <span class=na>condition=</span><span class=s>&#34;contains&#34;</span><span class=nt>&gt;</span>\Startup\<span class=nt>&lt;/TargetFilename&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/FileCreate&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;/RuleGroup&gt;</span>
</span></span></code></pre></td></tr></table></div></div><a href=#registry-key><h3 id=registry-key><span class=hanchor arialabel=Anchor># </span>Registry Key</h3></a><ul><li>SwiftOnSecurity detection this time for a registry modification that adjusts that places a script inside¬†<code>CurrentVersion\Windows\Run</code>¬†and other registry locations</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;RuleGroup</span> <span class=na>name=</span><span class=s>&#34;&#34;</span> <span class=na>groupRelation=</span><span class=s>&#34;or&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;RegistryEvent</span> <span class=na>onmatch=</span><span class=s>&#34;include&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;TargetObject</span> <span class=na>name=</span><span class=s>&#34;T1060,RunKey&#34;</span> <span class=na>condition=</span><span class=s>&#34;contains&#34;</span><span class=nt>&gt;</span>CurrentVersion\Run<span class=nt>&lt;/TargetObject&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;TargetObject</span> <span class=na>name=</span><span class=s>&#34;T1484&#34;</span> <span class=na>condition=</span><span class=s>&#34;contains&#34;</span><span class=nt>&gt;</span>Group Policy\Scripts<span class=nt>&lt;/TargetObject&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;TargetObject</span> <span class=na>name=</span><span class=s>&#34;T1060&#34;</span> <span class=na>condition=</span><span class=s>&#34;contains&#34;</span><span class=nt>&gt;</span>CurrentVersion\Windows\Run<span class=nt>&lt;/TargetObject&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/RegistryEvent&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;/RuleGroup&gt;</span>
</span></span></code></pre></td></tr></table></div></div><a href=#detecting-evasion-techniques><h2 id=detecting-evasion-techniques><span class=hanchor arialabel=Anchor># </span>Detecting Evasion Techniques</h2></a><ul><li>Various evasion techniques are used by malware authors to both evade anti-virus & detections <em>(e.g Alternate Data Streams, Injections, Masquerading, Packing/Compression, Recompiling, Obfuscation, Anti-Reversing Techniques)</em></li><li><a href=https://attack.mitre.org/techniques/T1055/ rel=noopener>Injection techniques</a> come in many different types: Thread Hijacking, PE Injection,¬†DLL¬†Injection, and more</li></ul><a href=#hunting-ads><h3 id=hunting-ads><span class=hanchor arialabel=Anchor># </span>Hunting ADS</h3></a><ul><li><a href=https://attack.mitre.org/techniques/T1564/004/ rel=noopener>Alternate Data Streams are used by malware</a> to hide its files from normal inspection by saving the file in a different stream apart from¬†<code>$DATA</code></li><li>Event ID 15 will hash and log any NTFS Streams that are included within the Sysmon configuration file</li><li>To aid in hunting ADS we will be using the SwiftOnSecurity Sysmon configuration file: will look for files in the¬†<code>Temp</code>¬†and¬†<code>Startup</code>¬†folder as well as¬†<code>.hta</code>¬†and¬†<code>.bat</code>¬†extension</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;RuleGroup</span> <span class=na>name=</span><span class=s>&#34;&#34;</span> <span class=na>groupRelation=</span><span class=s>&#34;or&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;FileCreateStreamHash</span> <span class=na>onmatch=</span><span class=s>&#34;include&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;TargetFilename</span> <span class=na>condition=</span><span class=s>&#34;contains&#34;</span><span class=nt>&gt;</span>Downloads<span class=nt>&lt;/TargetFilename&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;TargetFilename</span> <span class=na>condition=</span><span class=s>&#34;contains&#34;</span><span class=nt>&gt;</span>Temp\7z<span class=nt>&lt;/TargetFilename&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;TargetFilename</span> <span class=na>condition=</span><span class=s>&#34;ends with&#34;</span><span class=nt>&gt;</span>.hta<span class=nt>&lt;/TargetFilename&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;TargetFilename</span> <span class=na>condition=</span><span class=s>&#34;ends with&#34;</span><span class=nt>&gt;</span>.bat<span class=nt>&lt;/TargetFilename&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/FileCreateStreamHash&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;/RuleGroup&gt;</span>
</span></span></code></pre></td></tr></table></div></div><a href=#detecting-remote-threads><h3 id=detecting-remote-threads><span class=hanchor arialabel=Anchor># </span>Detecting Remote Threads</h3></a><ul><li>adversaries also commonly use remote threads to evade detections in combination with other techniques</li><li>remote threads are created using the Windows API¬†<code>CreateRemoteThread</code>¬†and can be accessed using¬†<code>OpenThread</code>¬†and¬†<code>ResumeThread</code></li><li>used in multiple evasion techniques including¬†DLL¬†Injection, Thread Hijacking, and Process Hollowing</li><li>will be using the Sysmon <code>eventID 8</code> from the SwiftOnSecurity configuration file</li><li>exclude common remote threads without including any specific attributes this allows for a more open and precise event rule</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;RuleGroup</span> <span class=na>name=</span><span class=s>&#34;&#34;</span> <span class=na>groupRelation=</span><span class=s>&#34;or&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;CreateRemoteThread</span> <span class=na>onmatch=</span><span class=s>&#34;exclude&#34;</span><span class=nt>&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;SourceImage</span> <span class=na>condition=</span><span class=s>&#34;is&#34;</span><span class=nt>&gt;</span>C:\Windows\system32\svchost.exe<span class=nt>&lt;/SourceImage&gt;</span>  
</span></span><span class=line><span class=cl>		<span class=nt>&lt;TargetImage</span> <span class=na>condition=</span><span class=s>&#34;is&#34;</span><span class=nt>&gt;</span>C:\Program Files (x86)\Google\Chrome\Application\chrome.exe<span class=nt>&lt;/TargetImage&gt;</span>  
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/CreateRemoteThread&gt;</span>  
</span></span><span class=line><span class=cl><span class=nt>&lt;/RuleGroup&gt;</span>
</span></span></code></pre></td></tr></table></div></div><a href=#detecting-evasion-techniques-with-powershell><h3 id=detecting-evasion-techniques-with-powershell><span class=hanchor arialabel=Anchor># </span>Detecting Evasion Techniques with PowerShell</h3></a><ul><li>Detecting Alternate Data Streams: <code>Get-WinEvent -Path &lt;Path to Log> -FilterXPath '*/System/EventID=15'</code></li><li>Detecting Remote Thread Creation: <code>Get-WinEvent -Path &lt;Path to Log> -FilterXPath '*/System/EventID=8'</code></li></ul><a href=#practical-investigations><h2 id=practical-investigations><span class=hanchor arialabel=Anchor># </span>Practical Investigations</h2></a><p>Event files used within this task have been sourced from the¬†
<a href=https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES/tree/master rel=noopener>EVTX-ATTACK-SAMPLES</a>¬†and¬†
<a href=https://github.com/jymcheong/SysmonResources rel=noopener>SysmonResources</a>Github repositories.</p><a href=#1---ugh-bill-thats-the-wrong-usb><h3 id=1---ugh-bill-thats-the-wrong-usb><span class=hanchor arialabel=Anchor># </span>1 - ugh, BILL THAT&rsquo;S THE WRONG USB!</h3></a><p>In this investigation, your team has received reports that a malicious file was dropped onto a host by a malicious USB. They have pulled the logs suspected and have tasked you with running the investigation for it.</p><ul><li>we see 4 <code>RawAccessRead</code> events<ul><li><code>RawAccessRead</code> event detects when a process conducts reading operations from the drive using the <code>\\.\</code> denotation</li><li>often used by malware for data exfiltration of files that are locked for reading, as well as to avoid file access auditing toolsA</li><li>exfiltrated 2 files: <code>explorer.exe</code> & <code>svchost.exe</code> on <code>\Device\HarddiskVolume3</code></li></ul></li><li>then it changes 2 regisstry keys<ul><li><code>HKLM\System\CurrentControlSet\Enum\WpdBusEnumRoot\UMB\</code></li><li><code>HKLM\SOFTWARE\Microsoft\Windows Portable Devices\Devices\WPDBUSENUMROOT</code></li></ul></li><li>uses the <code>WUDFHost.exe</code> <em>(
<a href=https://docs.microsoft.com/en-us/windows-hardware/drivers/wdf/overview-of-the-umdf rel=noopener>Windows User-Mode Driver Framework</a>)</em>:<ul><li><img src="/write-ups/images/Pasted image 20220615021517.png" width=auto></li></ul></li></ul><a href=#2---this-isnt-an-html-file><h3 id=2---this-isnt-an-html-file><span class=hanchor arialabel=Anchor># </span>2 - This isn&rsquo;t an HTML file?</h3></a><p>Another suspicious file has appeared in your logs and has managed to execute code masking itself as an HTML file, evading your anti-virus detections. Open the logs and investigate the suspicious file</p><ul><li>adversary made use of the <code>iexplore.exe</code> to lunch <code>update.hta</code> masked as an HTML file: <code>update.html</code></li><li>the <code>update.hta</code> was executed by <code>mshta.exe</code>, which provides ¬†the
<a href=https://win10.support/mshta-exe-microsoft-r-html-application-host/ rel=noopener>Microsoft HTML Application Host</a> that allow execution of <code>.hta</code> files <em>(HTML apps)</em></li><li>then, a network connection to their C2 was spawned<ul><li><img src="/write-ups/images/Pasted image 20220615025058.png" width=auto></li></ul></li></ul><a href=#31--32---wheres-the-bouncer-when-you-need-him><h3 id=31--32---wheres-the-bouncer-when-you-need-him><span class=hanchor arialabel=Anchor># </span>3.1 : 3.2 - Where&rsquo;s the bouncer when you need him</h3></a><p>Your team has informed you that the adversary has managed to set up persistence on your endpoints as they continue to move throughout your network. Find how the adversary managed to gain persistence using logs provided</p><ul><li>3.1<ul><li>adversary achieved persistence by uploading a payload to the <code>HKLM\SOFTWARE\Microsoft\Network\debug</code> registry</li><li>then to launch it used powershell: <code>C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe" -c "$x=$((gp HKLM:Software\Microsoft\Network debug).debug);start -Win Hidden -A \"-enc $x\" powershell";exit;uu</code></li><li>details about the connection <em>(ip, infected host)</em><ul><li><img src="/write-ups/images/Pasted image 20220615025709.png" width=auto></li></ul></li></ul></li><li>3.2<ul><li>attacker deployed payload in <code>c:\users\q\AppData:blah.txt</code> using <code>cmd.exe /C echo "payload"</code></li><li>then, created a scheduled task using the deployed payload through <code>schtasks.exe</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=s2>&#34;C:\WINDOWS\system32\schtasks.exe&#34;</span> <span class=p>/</span><span class=n>Create</span> <span class=p>/</span><span class=n>F</span> <span class=p>/</span><span class=nb>SC </span><span class=n>DAILY</span> <span class=p>/</span><span class=n>ST</span> <span class=n>09</span><span class=err>:</span><span class=n>00</span> <span class=p>/</span><span class=n>TN</span> <span class=n>Updater</span> <span class=p>/</span><span class=n>TR</span> <span class=s2>&#34;C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -NonI -W hidden -c \&#34;</span><span class=nb>IEX </span><span class=p>(</span><span class=no>[Text.Encoding]</span><span class=p>::</span><span class=n>UNICODE</span><span class=p>.</span><span class=n>GetString</span><span class=p>(</span><span class=no>[Convert]</span><span class=p>::</span><span class=n>FromBase64String</span><span class=p>($(</span><span class=n>cmd</span> <span class=p>/</span><span class=n>c</span> <span class=s1>&#39;&#39;</span><span class=n>more</span> <span class=p>&lt;</span> <span class=n>c:</span><span class=p>\</span><span class=n>users</span><span class=p>\</span><span class=n>q</span><span class=p>\</span><span class=n>AppData</span><span class=err>:</span><span class=n>blah</span><span class=p>.</span><span class=n>txt</span><span class=s1>&#39;&#39;</span><span class=err>&#39;</span><span class=p>))))\</span><span class=s2>&#34;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>following for `lsass.exe` to be accessed by the scheduled task
</span></span></code></pre></td></tr></table></div></div></li></ul><hr><a href=#references><h2 id=references><span class=hanchor arialabel=Anchor># </span>References</h2></a><ul><li><a href="https://docs.google.com/spreadsheets/d/17pSTDNpa0sf6pHeRhusvWG6rThciE8CsXTSlDUAZDyo/edit#gid=0" rel=noopener>Malware Back Connect Ports Spreadsheet</a></li></ul><a href=#see-also><h2 id=see-also><span class=hanchor arialabel=Anchor># </span>See Also</h2></a><ul><li><a href=/write-ups/thm/windows-event-logs rel=noopener class=internal-link data-src=/write-ups/thm/windows-event-logs>write-ups/thm/windows-event-logs</a></li><li><a href=/write-ups/THM rel=noopener class=internal-link data-src=/write-ups/THM>write-ups/THM</a></li></ul></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/write-ups/thm/sysinternals/ data-ctx=write-ups/thm/sysmon data-src=/write-ups/thm/sysinternals class=internal-link>SysInternals</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://hakbrain.xyz/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Vl@gh3 using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, ¬© 2022</p><ul><li><a href=https://hakbrain.xyz/>Home</a></li><li><a href=https://twitter.com/vlaghe1>Twitter</a></li><li><a href=https://github.com/vlagh3>Github</a></li></ul></footer></div></div></body></html>