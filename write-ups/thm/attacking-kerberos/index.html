<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="What is Kerberos ?  Kerberos is the default authentication service for Microsoft Windows domains\ an authentication protocol, not authorization. It allows identification 4 each user, but doesn&rsquo;t validate to which reources/services can the user access intented to be more secure than NTLM by using third party ticket authorization as well as stronger encryption several agents work together to provide authentication in Kerberos:  Client/User who wants to access the service Application Server (AP) which offers the service required by the user Key Distribution Center (KDC): the main service, responsible of issuing the tickets, installed on the [AD &ndash; Domain Controllers (DC)](."><title>attacking-kerberos</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://hakbrain.xyz//icon.png><link href=https://hakbrain.xyz/styles.f40f9c8ac1c106641723dab5233fc67c.min.css rel=stylesheet><link href=https://hakbrain.xyz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://hakbrain.xyz/js/darkmode.8bfc78cc60cc5da6df81ec79c82c3775.min.js></script>
<script src=https://hakbrain.xyz/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://hakbrain.xyz/js/popover.abe6a51cc7138c5dff00f151dd627ad1.min.js></script>
<script src=https://hakbrain.xyz/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://hakbrain.xyz/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://hakbrain.xyz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://hakbrain.xyz/",fetchData=Promise.all([fetch("https://hakbrain.xyz/indices/linkIndex.9a01892b9427821b81e58f128fb19864.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://hakbrain.xyz/indices/contentIndex.ea921af160e84115f7c5eda47b9f6e92.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://hakbrain.xyz",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://hakbrain.xyz",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/hakbrain.xyz\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://hakbrain.xyz/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://hakbrain.xyz/>üï∏Ô∏è H@kBr4in</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>attacking-kerberos</h1><p class=meta>Last updated
Sep 6, 2022
<a href=https://github.com/vlagh3/hakbrain/tree/hugo/content/write-ups/thm/attacking-kerberos.md rel=noopener>Edit Source</a></p><ul class=tags><li><a href=https://hakbrain.xyz/tags/writeups/>Writeups</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#what-is-kerberos->What is Kerberos ?</a><ol><li><a href=#tickets>Tickets</a></li><li><a href=#privilege-attribute-certificate-pac>Privilege Attribute Certificate <em>(PAC)</em></a></li><li><a href=#types-of-mesages>Types of mesages</a></li><li><a href=#kerberos-authentication-overview>Kerberos Authentication Overview</a></li><li><a href=#attack-privilege-requirement>Attack Privilege Requirement</a></li></ol></li><li><a href=#abusing-pre-auth>Abusing Pre-Auth</a></li><li><a href=#harvesting--brute-forcing-tickets>Harvesting & Brute-Forcing Tickets</a></li><li><a href=#kerberoasting>Kerberoasting</a><ol><li><a href=#what-can-a-service-account-do>What Can a Service Account do?</a></li><li><a href=#mitigations>Mitigations</a></li></ol></li><li><a href=#as-rep-roasting>AS-REP Roasting</a><ol><li><a href=#mitigation>Mitigation</a></li></ol></li><li><a href=#pass-the-ticket>Pass the Ticket</a><ol><li><a href=#mitigation-1>Mitigation</a></li></ol></li><li><a href=#golden--silver-ticket-attacks>Golden / Silver Ticket Attacks</a><ol><li><a href=#whats-the-difference-between-a-krbtgt-and-a-tgt->What&rsquo;s the difference between a KRBTGT and a TGT ?</a></li><li><a href=#hands-on>Hands-On</a></li></ol></li><li><a href=#kerberos-backdoors>Kerberos Backdoors</a></li><li><a href=#references>References</a></li><li><a href=#see-also>See Also</a></li></ol></nav></details></aside><a href=#what-is-kerberos-><h2 id=what-is-kerberos-><span class=hanchor arialabel=Anchor># </span>What is Kerberos ?</h2></a><ul><li>Kerberos is the default authentication service for Microsoft Windows domains\</li><li>an authentication protocol, not authorization. It allows identification 4 each user, but doesn&rsquo;t validate to which reources/services can the user access</li><li>intented to be more secure than NTLM ¬†by using third party ticket authorization as well as stronger encryption</li><li>several <strong>agents</strong> work together to provide authentication in Kerberos:<ul><li>Client/User who wants to access the service</li><li>Application Server <em>(AP)</em> which offers the service required by the user</li><li>Key Distribution Center <em>(KDC)</em>: the main service, responsible of issuing the tickets, installed on the [AD &ndash; Domain Controllers (DC)](../../sheets/AD &ndash; Domain Controllers (DC).md) & supported by the Authentication Service <em>(AS)</em>, which issues TGTs</li></ul></li></ul><a href=#tickets><h3 id=tickets><span class=hanchor arialabel=Anchor># </span>Tickets</h3></a><p>The main structures handled by Kerberos. They&rsquo;re delivered to the users in order to be used by them to perform several actions.</p><ul><li><strong>Ticket Granting Service (TGS)</strong>: users can use to authenticate against a service. It is encrypted with the service key<ul><li><img src="/write-ups/images/Pasted image 20220619113227.png" width=auto></li></ul></li><li><strong>Ticket Granting Ticket (TGT)</strong>: presented to the KDC to request for TGSs. It is encrypted with the KDC key<ul><li><img src="/write-ups/images/Pasted image 20220619113222.png" width=auto></li></ul></li></ul><a href=#privilege-attribute-certificate-pac><h3 id=privilege-attribute-certificate-pac><span class=hanchor arialabel=Anchor># </span>Privilege Attribute Certificate <em>(PAC)</em></h3></a><p>It&rsquo;s a structure included in almost every ticket. This structure contains the privileges of the user and it is signed with the KDC key.</p><p>PAC verification consists of checking only its signature, without inspecting if privileges inside of PAC are correct. Furthermore, a client can avoid the inclusion of the PAC inside the ticket by specifying it in <code>KERB-PA-PAC-REQUEST</code> field of ticket request</p><a href=#types-of-mesages><h3 id=types-of-mesages><span class=hanchor arialabel=Anchor># </span>Types of mesages</h3></a><p>Kerberos uses differents kinds of messages. The most interesting are the following:</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td><strong>KRB_AS_REQ</strong></td><td>used to request the TGT to KDC</td></tr><tr><td><strong>KRB_AS_REP</strong></td><td>used to deliver the TGT by KDC</td></tr><tr><td><strong>KRB_TGS_REQ</strong></td><td>used to request the TGS to KDC, using the TGT</td></tr><tr><td><strong>KRB_TGS_REP</strong></td><td>used to deliver the TGS by KDCM</td></tr><tr><td><strong>KRB_AP_REQ</strong></td><td>used to authenticate a user against a service, using the TGS</td></tr><tr><td><strong>KRB_AP_REP</strong></td><td>(optional) used by servicee to identify itself against the user</td></tr><tr><td><strong>KPB_ERROR</strong></td><td>msg to communicate error conditions</td></tr></tbody></table><blockquote><p><strong>NOTE</strong>: Additionally, even if it is not part of Kerberos, but NRPC, the <strong>AP</strong> optionally could use the <code>KERB_VERIFY_PAC_REQUEST</code> message to send to <strong>KDC</strong> the signature of <strong>PAC</strong>, and verify if it is correc</p></blockquote><p>Summary of msgs sequency to perform auth:
<img src="/write-ups/images/Pasted image 20220619113911.png" width=auto></p><a href=#kerberos-authentication-overview><h3 id=kerberos-authentication-overview><span class=hanchor arialabel=Anchor># </span>Kerberos Authentication Overview</h3></a><p><img src="/write-ups/images/Pasted image 20220619072424.png" width=auto></p><ol><li>client requests an Authentication Ticket or Ticket Granting Ticket (TGT)</li><li>Key Distribution Center verifies the client and sends back an encrypted TGT</li><li>client sends the encrypted TGT to the Ticket Granting Server (TGS) with the Service Principal Name (SPN) of the service the client wants to access</li><li>KDC verifies the TGT of the user and that the user has access to the service, then sends a valid session key for the service to the client</li><li>client requests the service and sends the valid session key to prove the user has access</li><li>the service grants access</li></ol><a href=#attack-privilege-requirement><h3 id=attack-privilege-requirement><span class=hanchor arialabel=Anchor># </span>Attack Privilege Requirement</h3></a><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Kerbrute Enumeration</td><td>no domain access required</td></tr><tr><td>Pass the Ticket</td><td>access as a user to the domain required</td></tr><tr><td>Kerberoasting</td><td>access as any user required</td></tr><tr><td>AS-REP Roasting</td><td>access as any user required</td></tr><tr><td>Golden Ticket</td><td>full domain compromise <em>(domain admin)</em></td></tr><tr><td>Silver Ticket</td><td>service hash required</td></tr><tr><td>Skeleton Key</td><td>full domain compromise <em>(domain admin)</em></td></tr></tbody></table><a href=#abusing-pre-auth><h2 id=abusing-pre-auth><span class=hanchor arialabel=Anchor># </span>Abusing Pre-Auth</h2></a><ul><li>by brute-forcing in pre-auth we don&rsquo;t trigger the account failed to log an event which can throw up red flags to the blue team</li><li>we can brute-force by only sending a single¬†UDP¬†frame to the KDC allowing you to enumerate the users on the domain from a wordlist</li><li>using
<a rel=noopener class="internal-link broken" data-src=#ZgotmplZ>kerbrute</a>:<ul><li><img src="/write-ups/images/Pasted image 20220619120038.png" width=auto></li></ul></li></ul><a href=#harvesting--brute-forcing-tickets><h2 id=harvesting--brute-forcing-tickets><span class=hanchor arialabel=Anchor># </span>Harvesting & Brute-Forcing Tickets</h2></a><ul><li>harvesting tickets uing
<a href=https://github.com/GhostPack/Rubeus rel=noopener>Rubeus</a>: <code>Rubeus.exe harvest /interval:30</code><ul><li><img src="/write-ups/images/Pasted image 20220619120554.png" width=auto></li></ul></li><li>add the domain controller domain name to the windows host file: <code>echo 10.10.72.127 CONTROLLER.local >> C:\Windows\System32\drivers\etc\hosts</code></li><li><em>&ldquo;spray&rdquo;</em> against all found user accounts in the domain to find which one may have that password: <code>Rubeus.exe brute /password:Password1 /noticket</code><ul><li><img src="/write-ups/images/Pasted image 20220619122207.png" width=auto></li></ul></li></ul><blockquote><p><strong>NOTE</strong>: be mindful of how you use this attack as it may lock you out of the network depending on the account lockout policies</p></blockquote><a href=#kerberoasting><h2 id=kerberoasting><span class=hanchor arialabel=Anchor># </span>Kerberoasting</h2></a><ul><li>with <code>rubues</code>: <code>Rubeus.exe kerberoast</code></li><li>with
<a href=https://github.com/SecureAuthCorp/impacket rel=noopener>impacket</a>: <code>sudo python3 GetUserSPNs.py controller.local/Machine1:Password1 -dc-ip 10.10.72.127 -request</code><ul><li><img src="/write-ups/images/Pasted image 20220619122329.png" width=auto></li></ul></li><li>and crack the hash: <code>hashcat -m 13100 -a 0 hash.txt Pass.txt</code><ul><li><img src="/write-ups/images/Pasted image 20220619122724.png" width=auto></li></ul></li></ul><a href=#what-can-a-service-account-do><h3 id=what-can-a-service-account-do><span class=hanchor arialabel=Anchor># </span>What Can a Service Account do?</h3></a><ul><li>once you havee a service account there&rsquo;s various ways to further exfiltrate data or collecting loot depending on whether the service is a domain admin or not</li><li>if a domain admin you have control similar to that of a golden/silver ticket and can now gather loot such as dumping the NTDS.dit</li><li>if not a domain admin you can use it to log into other systems and pivot or escalate or you can use that cracked password to spray against other service and domain admin accounts</li></ul><a href=#mitigations><h3 id=mitigations><span class=hanchor arialabel=Anchor># </span>Mitigations</h3></a><p><strong>Strong Service Passwords</strong>: if the service account passwords are strong then kerberoasting will be ineffective</p><p><strong>Don&rsquo;t Make Service Accounts Domain Admins</strong>: service accounts don&rsquo;t need to be domain admins, kerberoasting won&rsquo;t be as effective if you don&rsquo;t make service accounts domain admins.</p><a href=#as-rep-roasting><h2 id=as-rep-roasting><span class=hanchor arialabel=Anchor># </span>AS-REP Roasting</h2></a><p>Similar to Kerberoasting, AS-REP Roasting dumps the krbasrep5 hashes of user accounts that have Kerberos pre-authentication disabled</p><ul><li>During pre-auth the user&rsquo;s hash will be used to encrypt a timestamp that the DC will attempt to decrypt in order to validate that the right hash is being used and is not replaying a previous request</li><li>After validation, the KDC will then issue a TGT for the user</li><li>If pre-auth is disabled we can <strong>request any authentication data for any user and the KDC will return an encrypted TGT</strong> <em>(which can further be cracked offline)</em></li></ul><p><img src="/write-ups/images/Pasted image 20220619123731.png" width=auto></p><p>If we crack the hashes: <code>hashcat -m 18200 AS-REP Pass.txt</code> we get: <code>admin2:P@$$W0rd2, user3:Password3</code>
<img src="/write-ups/images/Pasted image 20220619123955.png" width=auto></p><a href=#mitigation><h3 id=mitigation><span class=hanchor arialabel=Anchor># </span>Mitigation</h3></a><p><strong>Have a strong password policy</strong>. With a strong password, the hashes will take longer to crack making this attack less effective</p><p><strong>Don&rsquo;t turn off Kerberos Pre-Authentication unless it&rsquo;s necessary</strong> there&rsquo;s almost no other way to completely mitigate this attack other than keeping Pre-Authentication on.</p><a href=#pass-the-ticket><h2 id=pass-the-ticket><span class=hanchor arialabel=Anchor># </span>Pass the Ticket</h2></a><p>Pass the ticket works by dumping the TGT from the LSASS memory of the machine. The <a href=/write-ups/thm/core-windows-processes#lsass-exe rel=noopener class=internal-link data-src=/write-ups/thm/core-windows-processes>lsass.exe</a> stores credentials for the AD server & Kerberos tickets along w other creds in memory</p><p>A known tool exactly for that is
<a href=https://github.com/ParrotSec/mimikatz rel=noopener>mimikatz</a>. This will give us a .kirbi ticket which can be used to gain domain admin if a domain admin ticket is in the LSASS memory.</p><p>You can think of a pass the ticket attack like reusing an existing ticket were not creating or destroying any tickets here were simply reusing an existing ticket from another user on the domain and impersonating that ticket.</p><p><img src="/write-ups/images/Pasted image 20220619124706.png" width=auto></p><ul><li>dump all <code>.kirbi</code> tickets in the curr dir w <code>mimikatz</code>:<ul><li><img src="/write-ups/images/Pasted image 20220619125509.png" width=auto></li></ul></li><li>pass the ticket & impersonate<ul><li>find someone valuable to impersonate, in our case <code>Administrator</code></li><li><img src="/write-ups/images/Pasted image 20220619125719.png" width=auto></li><li>verifying that we successfully impersonated the ticket by listing our cached tickets: <code>klist</code></li><li><img src="/write-ups/images/Pasted image 20220619125416.png" width=auto></li></ul></li></ul><blockquote><p><strong>NOTE</strong>: this is only a POC to understand how to pass the ticket and gain domain admin, so don&rsquo;t take this as a definitive guide of how to run this attack, since the approach might change based on the environment</p></blockquote><a href=#mitigation-1><h3 id=mitigation-1><span class=hanchor arialabel=Anchor># </span>Mitigation</h3></a><p><strong>Don&rsquo;t let your domain admins log onto anything except the domain controller</strong>: this is something so simple however a lot of domain admins still log onto low-level computers leaving tickets around that we can use to attack and move laterally with.</p><a href=#golden--silver-ticket-attacks><h2 id=golden--silver-ticket-attacks><span class=hanchor arialabel=Anchor># </span>Golden / Silver Ticket Attacks</h2></a><ul><li>a silver ticket can sometimes be better used in engagements rather than a golden ticket because it is a little more discreet<ul><li>silver ticket: limited to the service that is targeted</li><li>golden ticket: has access to any Kerberos service</li></ul></li><li><strong>use-scenario</strong>: you want to access the domain&rsquo;s SQL server, but the curr compromised user doesn&rsquo;t have access<ul><li>find an accessible service account to get a foothold with by kerberoasting</li><li>then dump the service hash</li><li>and finally impersonate their TGT in order to request a service ticket for the SQL service</li></ul></li></ul><a href=#whats-the-difference-between-a-krbtgt-and-a-tgt-><h3 id=whats-the-difference-between-a-krbtgt-and-a-tgt-><span class=hanchor arialabel=Anchor># </span>What&rsquo;s the difference between a KRBTGT and a TGT ?</h3></a><ul><li>a KRBTGT is the service account for the KDC, which issues all of the tickets to the clients</li><li>by impersonating this acc & creating a golden ticket you give yourself the ability to create a service ticket for anything you want</li></ul><a href=#hands-on><h3 id=hands-on><span class=hanchor arialabel=Anchor># </span>Hands-On</h3></a><ul><li>dump the hash as well as the security identifier needed to create a Golden Ticket <em>(to create a silver ticket change <code>/name:</code> to dump the hash of either a domain admin / service acc you&rsquo;re interested in)</em><ul><li><img src="/write-ups/images/Pasted image 20220619131924.png" width=auto></li></ul></li><li>create a golden/silver ticket: <code>Kerberos::golden /user:Administrator /domain:controller.local /sid: /krbtgt: /id:</code> <em>(4 silver ticket ¬†simply put a service NTLM hash into the krbtgt slot, the sid of the service account into sid, and change the id to 1103)</em><ul><li><img src="/write-ups/images/Pasted image 20220619132541.png" width=auto></li></ul></li><li>use the golden/silver ticket to access other machines: <code>misc::cmd</code> which will open a new elevated cmd with the given ticket</li></ul><a href=#kerberos-backdoors><h2 id=kerberos-backdoors><span class=hanchor arialabel=Anchor># </span>Kerberos Backdoors</h2></a><p>Unlike the golden and silver ticket attacks a Kerberos backdoor is much more subtle because it acts similar to a rootkit by implanting itself into the memory of the domain forest allowing itself access to any of the machines with a master password</p><p>It works by implanting a skeleton key that abuses the way that the AS-REQ validates encrypted timestamps. A skeleton key only works using Kerberos RC4 encryption.</p><p>The DC then tries to decrypt the timestamp with the users NT hash, once a skeleton key is implanted the domain controller tries to decrypt the timestamp using both the user NT hash and the¬†skeleton key NT hash allowing you access to the domain forest</p><blockquote><p><strong>NOTE</strong>: the skeleton key will not persist by itself because it runs in the memory</p></blockquote><hr><a href=#references><h2 id=references><span class=hanchor arialabel=Anchor># </span>References</h2></a><ul><li><a href=https://medium.com/@t0pazg3m/pass-the-ticket-ptt-attack-in-mimikatz-and-a-gotcha-96a5805e257a rel=noopener>https://medium.com/@t0pazg3m/pass-the-ticket-ptt-attack-in-mimikatz-and-a-gotcha-96a5805e257a</a>
<a href=https://medium.com/@t0pazg3m/pass-the-ticket-ptt-attack-in-mimikatz-and-a-gotcha-96a5805e257a rel=noopener></a></li><li><a href=https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/as-rep-roasting-using-rubeus-and-hashcat rel=noopener>https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/as-rep-roasting-using-rubeus-and-hashcat</a>
<a href=https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/as-rep-roasting-using-rubeus-and-hashcat rel=noopener></a></li><li><a href=https://posts.specterops.io/kerberoasting-revisited-d434351bd4d1 rel=noopener>https://posts.specterops.io/kerberoasting-revisited-d434351bd4d1</a>
<a href=https://posts.specterops.io/kerberoasting-revisited-d434351bd4d1 rel=noopener></a></li><li><a href=https://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/ rel=noopener>https://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/</a>
<a href=https://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/ rel=noopener></a></li><li><a href=https://www.varonis.com/blog/kerberos-authentication-explained/ rel=noopener>https://www.varonis.com/blog/kerberos-authentication-explained/</a>
<a href=https://www.varonis.com/blog/kerberos-authentication-explained/ rel=noopener></a></li><li><a href=https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don%27t-Get-It-wp.pdf rel=noopener>https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don&rsquo;t-Get-It-wp.pdf</a>
<a href=https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don%27t-Get-It-wp.pdf rel=noopener></a></li><li><a href=https://www.sans.org/cyber-security-summit/archives/file/summit-archive-1493862736.pdf rel=noopener>https://www.sans.org/cyber-security-summit/archives/file/summit-archive-1493862736.pdf</a>
<a href=https://www.sans.org/cyber-security-summit/archives/file/summit-archive-1493862736.pdf rel=noopener></a></li><li><a href=https://www.redsiege.com/wp-content/uploads/2020/04/20200430-kerb101.pdf rel=noopener>https://www.redsiege.com/wp-content/uploads/2020/04/20200430-kerb101.pdf</a></li></ul><a href=#see-also><h2 id=see-also><span class=hanchor arialabel=Anchor># </span>See Also</h2></a><ul><li><a href=/write-ups/THM rel=noopener class=internal-link data-src=/write-ups/THM>write-ups/THM</a></li></ul></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://hakbrain.xyz/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Vl@gh3 using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, ¬© 2022</p><ul><li><a href=https://hakbrain.xyz/>Home</a></li><li><a href=https://twitter.com/vlaghe1>Twitter</a></li><li><a href=https://github.com/vlagh3>Github</a></li></ul></footer></div></div></body></html>