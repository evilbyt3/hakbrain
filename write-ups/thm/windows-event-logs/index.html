<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Event Viewer 1 2 3 4 5 6 7 8 9 10 11 12  # Get all powershell log events w id = 800 Get-EventLog 'Windows Powershell' | Where-Object {$_."><title>Windows Event Logs</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://hakbrain.xyz//icon.png><link href=https://hakbrain.xyz/styles.f40f9c8ac1c106641723dab5233fc67c.min.css rel=stylesheet><link href=https://hakbrain.xyz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://hakbrain.xyz/js/darkmode.8bfc78cc60cc5da6df81ec79c82c3775.min.js></script>
<script src=https://hakbrain.xyz/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://hakbrain.xyz/js/popover.abe6a51cc7138c5dff00f151dd627ad1.min.js></script>
<script src=https://hakbrain.xyz/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://hakbrain.xyz/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://hakbrain.xyz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://hakbrain.xyz/",fetchData=Promise.all([fetch("https://hakbrain.xyz/indices/linkIndex.3b45598c5a0d8dd3dd7824af149a522d.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://hakbrain.xyz/indices/contentIndex.7237fc49b072a2a293fa9da2e7e12f2d.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://hakbrain.xyz",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://hakbrain.xyz",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/hakbrain.xyz\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://hakbrain.xyz/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://hakbrain.xyz/>üï∏Ô∏è H@kBr4in</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Windows Event Logs</h1><p class=meta>Last updated
Dec 9, 2022
<a href=https://github.com/vlagh3/hakbrain/tree/hugo/content/write-ups/thm/windows-event-logs.md rel=noopener>Edit Source</a></p><ul class=tags><li><a href=https://hakbrain.xyz/tags/writeups/>Writeups</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#event-viewer>Event Viewer</a></li><li><a href=#wevtutilexe><code>wevtutil.exe</code></a></li><li><a href=#get-wineventhttpsdocsmicrosoftcomen-uspowershellmodulemicrosoftpowershelldiagnosticsget-wineventviewpowershell-51><a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.diagnostics/get-winevent?view=powershell-5.1"><code>Get-WinEvent</code></a></a></li><li><a href=#xpathhttpsdocsmicrosoftcomen-usprevious-versionsdotnetnetframework-40ms256115vvs100-queries><a href="https://docs.microsoft.com/en-us/previous-versions/dotnet/netframework-4.0/ms256115(v=vs.100)">XPath</a> Queries</a><ol><li><a href=#answers>Answers</a></li></ol></li><li><a href=#event-ids>Event IDs</a></li><li><a href=#answers-1>Answers</a></li><li><a href=#references>References</a></li><li><a href=#see-also>See Also</a></li></ol></nav></details></aside><a href=#event-viewer><h2 id=event-viewer><span class=hanchor arialabel=Anchor># </span>Event Viewer</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Get all powershell log events w id = 800</span>
</span></span><span class=line><span class=cl><span class=nb>Get-EventLog</span> <span class=s1>&#39;Windows Powershell&#39;</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=n>EventID</span> <span class=o>-eq</span> <span class=n>800</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Display properties </span>
</span></span><span class=line><span class=cl><span class=nb>Get-EventLog</span> <span class=s1>&#39;Windows Powershell&#39;</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=n>EventID</span> <span class=o>-eq</span> <span class=n>800</span><span class=p>}</span> <span class=p>|</span> <span class=nb>Select-Object</span> <span class=n>-Property</span> <span class=p>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=n>EventID</span>		<span class=err>:</span> <span class=n>800</span>
</span></span><span class=line><span class=cl>	<span class=n>MachineName</span>	<span class=err>:</span> <span class=n>WIN</span><span class=p>-</span><span class=n>1O0UJBNP9G7</span>
</span></span><span class=line><span class=cl>	<span class=n>Data</span>		<span class=err>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=n>Index</span>		<span class=err>:</span> <span class=n>4213</span>
</span></span><span class=line><span class=cl>	<span class=n>Category</span>	<span class=err>:</span> <span class=n>Pipeline</span> <span class=n>Execution</span> <span class=n>Details</span>
</span></span><span class=line><span class=cl>	<span class=n>CategoryNr</span>	<span class=err>:</span> <span class=n>8</span>
</span></span></code></pre></td></tr></table></div></div><a href=#wevtutilexe><h2 id=wevtutilexe><span class=hanchor arialabel=Anchor># </span><code>wevtutil.exe</code></h2></a><ul><li>enables you to retrieve information about event logs and publishers. You can also use this command to install and uninstall event manifests, to run queries, and to export, archive, and clear logs.</li><li>help: <code>wevtutil.exe /?</code> & <code>wevtutil.exe CMD /?</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># how many log names are in the machine</span>
</span></span><span class=line><span class=cl><span class=n>wevtutil</span><span class=p>.</span><span class=n>exe</span> <span class=n>el</span> <span class=p>|</span> <span class=nb>Measure-Object</span>
</span></span><span class=line><span class=cl>	<span class=n>Count</span><span class=err>:</span> <span class=n>1071</span>
</span></span><span class=line><span class=cl><span class=c># get the 3 most recent application log events in text format</span>
</span></span><span class=line><span class=cl><span class=n>wevtutil</span><span class=p>.</span><span class=n>exe</span> <span class=n>qe</span> <span class=n>Application</span> <span class=p>/</span><span class=n>c:3</span> <span class=p>/</span><span class=n>rd</span><span class=err>:</span><span class=n>true</span> <span class=p>/</span><span class=n>f:text</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=get-wineventhttpsdocsmicrosoftcomen-uspowershellmodulemicrosoftpowershelldiagnosticsget-wineventviewpowershell-51><a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.diagnostics/get-winevent?view=powershell-5.1" rel=noopener><code>Get-WinEvent</code></a></h2><ul><li>gets events from event logs and event tracing log files on local and remote computers</li><li><strong>Get-WinEvent</strong>¬†cmdlet replaces the¬†
<a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-eventlog?view=powershell-5.1" rel=noopener>Get-EventLog</a>¬†cmdlet</li><li>generally you can filter events like so: <code>Get-WinEvent -LogName Application | Where-Object { $_.ProviderName -Match 'WLMS' }</code></li><li><code>FilterHashtable</code> parameter
<a href="https://docs.microsoft.com/en-us/powershell/scripting/samples/Creating-Get-WinEvent-queries-with-FilterHashtable?view=powershell-7.2&viewFallbackFrom=powershell-7.1" rel=noopener>is recommended</a> to filter event logs<ul><li>Guidelines</li><li><img src="/write-ups/images/Pasted image 20220613010805.png" width=auto></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WinEvent</span> <span class=n>-FilterHashTable</span> <span class=p>@{</span>
</span></span><span class=line><span class=cl>	<span class=n>LogName</span><span class=p>=</span><span class=s2>&#34;Application&#34;</span>
</span></span><span class=line><span class=cl>	<span class=n>ProviderName</span><span class=p>=</span><span class=s2>&#34;WLMS&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Event Viewer](https://docs.microsoft.com/en-us/shows/inside/event-viewer) can provide quick information on what you need to build your hash table
</span></span><span class=line><span class=cl>more about hashtables in general [here](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_hash_tables?view=powershell-7.2&amp;viewFallbackFrom=powershell-7.1)
</span></span></code></pre></td></tr></table></div></div></li></ul><h2 id=xpathhttpsdocsmicrosoftcomen-usprevious-versionsdotnetnetframework-40ms256115vvs100-queries><a href="https://docs.microsoft.com/en-us/previous-versions/dotnet/netframework-4.0/ms256115%28v=vs.100%29" rel=noopener>XPath</a> Queries</h2><ul><li>W3C created XPath (or¬†<strong>XML¬†Path Language</strong>). The Windows Event Log supports a subset of¬†
<a href=https://www.w3.org/TR/1999/REC-xpath-19991116/ rel=noopener>XPath 1.0</a></li><li><img src="/write-ups/images/Pasted image 20220613011533.png" width=auto></li><li>an XPath event query starts with <code>'*'</code> or <code>'Event'</code></li><li>can use Event Viewer&rsquo;s <code>Details > XML View</code> to build queries:<ul><li><code>Get-WinEvent -LogName Application -FilterXPath '*/System/EventID=100'</code></li><li><img src="/write-ups/images/Pasted image 20220613014242.png" width=auto></li><li>or on a different element w attributes: <code>Get-WinEvent -LogName Application -FilterXPath '*/System/Provider[@Name="WLMS"]'</code></li></ul></li><li>combining queries: <code>Get-WinEvent -LogName Application -FilterXPath '*/System/EventID=101 and */System/Provider[@Name="WLMS"]'</code></li><li>for elements within <code>EventData</code> it will be slightly different: <code>Get-WinEvent -LogName Security -FilterXPath '*/EventData/Data[@Name="TargetUserName"]="System"'</code><ul><li><img src="/write-ups/images/Pasted image 20220613014440.png" width=auto></li></ul></li></ul><a href=#answers><h3 id=answers><span class=hanchor arialabel=Anchor># </span>Answers</h3></a><p><img src="/write-ups/images/Pasted image 20220613013949.png" width=auto></p><ul><li>Using¬†<strong>Get-WinEvent</strong>¬†and¬†<strong>XPath</strong>, what is the query to find WLMS events with a System Time of¬†2020-12-15T01:09:08.940277500Z?<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WinEvent</span> <span class=n>-LogName</span> <span class=n>Application</span> <span class=n>-FilterXPath</span> <span class=s1>&#39;*/System/TimeCreated[@SystemTime=&#34;2020-12-15T01:09:08.940277500Z&#34;] and */System/Provider[@Name=&#34;WLMS&#34;]&#39;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li><li>Using¬†<strong>Get-WinEvent</strong>¬†and¬†<strong>XPath</strong>, what is the query to find a user named Sam with an Logon Event ID of 4720?<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WinEvent</span> <span class=n>-LogName</span> <span class=n>Security</span> <span class=n>-FilterXPath</span> <span class=s1>&#39;*/EventData/Data[@Name=&#34;TargetUserName&#34;]=&#34;Sam&#34; and */System/EventID=4720&#39;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li><li>Based on the previous query, how many results are returned? : 2</li><li>Based on the output from the question #2, what is Message? : <code>A user account was creaated</code></li><li>Still working with Sam as the user, what time was Event ID 4724 recorded? (<strong>MM/DD/YYYY H:MM:SS AM/PM</strong>): <code>12/17/2020 1:57:14 PM</code></li><li>What is the Provider Name? <code>Microsoft-Windows-Security-Auditing</code></li></ul><a href=#event-ids><h2 id=event-ids><span class=hanchor arialabel=Anchor># </span>Event IDs</h2></a><p>When it comes to monitoring and hunting, you need to know what you are looking for. How do we pick from the large pool of event IDs?</p><ul><li><a href=https://static1.squarespace.com/static/552092d5e4b0661088167e5c/t/580595db9f745688bc7477f6/1476761074992/Windows+Logging+Cheat+Sheet_ver_Oct_2016.pdf rel=noopener>The Windows Logging Cheat Sheet (Windows 7 - Windows 2012)</a></li><li><a href=https://www.malwarearchaeology.com/cheat-sheets rel=noopener>Various Windows cheatsheetss</a></li><li><a href=https://apps.nsa.gov/iaarchive/library/reports/spotting-the-adversary-with-windows-event-log-monitoring.cfm rel=noopener>Spotting the Adversary with Windows Event Log Monitoring</a> <em>(NSA)</em></li><li>from <a class="internal-link broken">Mitre ATT&CK</a></li><li><a href=https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor rel=noopener>Events to Monitor Windows</a></li><li><a href="https://www.microsoft.com/en-us/download/confirmation.aspx?id=52630" rel=noopener>The Windows 10 and Windows Server 2016 Security Auditing and Monitoring Reference</a>¬†<em>(a comprehensive list <strong>over 700 pages</strong>)</em></li></ul><blockquote><p><strong>Note</strong>: Some events will not be generated by default, and certain features will need to be enabled/configured on the endpoint, such as PowerShell logging. This feature can be enabled via¬†<strong>Group Policy</strong>¬†or the¬†<strong>Registry</strong>: <code>Local Computer Policy > Computer Configuration > Administrative Templates > Windows Components > Windows PowerShell</code></p></blockquote><ul><li>more on enabling it<ul><li><a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_logging_windows?view=powershell-7.1" rel=noopener>About Logging Windows</a></li><li><a href=https://www.fireeye.com/blog/threat-research/2016/02/greater_visibilityt.html rel=noopener>Greater Visibility Through PowerShell Logging</a></li><li><a href=https://docs.splunk.com/Documentation/UBA/5.0.4/GetDataIn/AddPowerShell rel=noopener>Configure PowerShell logging to see PowerShell anomalies in Splunk UBA</a></li></ul></li></ul><a href=#answers-1><h2 id=answers-1><span class=hanchor arialabel=Anchor># </span>Answers</h2></a><ul><li><p><strong>Scenario I</strong>: The server admins have made numerous complaints to Management regarding PowerShell being blocked in the environment. Management finally approved the usage of PowerShell within the environment. Visibility is now needed to ensure there are no gaps in coverage. You researched this topic: what logs to look at, what event IDs to monitor, etc. You enabled PowerShell logging on a test machine and had a colleague execute various commands</p><ul><li><p>What event ID is to detect a PowerShell downgrade attack?: <code>400</code> from
<a href=https://www.leeholmes.com/detecting-and-preventing-powershell-downgrade-attacks/ rel=noopener>this</a></p></li><li><p>What is the¬†<strong>Date and Time</strong>¬†this attack took place?¬†(<strong>MM/DD/YYYY H:MM:SS AM/PM</strong>)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WinEvent</span> <span class=n>-Path</span> <span class=p>.\</span><span class=n>merged</span><span class=p>.</span><span class=n>evtx</span> <span class=p>|</span>
</span></span><span class=line><span class=cl>	<span class=nb>Where-Object</span> <span class=n>Id</span> <span class=o>-eq</span> <span class=n>400</span> <span class=p>|</span>
</span></span><span class=line><span class=cl>	<span class=nb>Foreach-Object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nv>$version</span> <span class=p>=</span> <span class=no>[Version]</span> <span class=p>(</span><span class=nv>$_</span><span class=p>.</span><span class=n>Message</span> <span class=o>-replace</span> <span class=s1>&#39;(?s).*EngineVersion=([\d\.]+)*.*&#39;</span><span class=p>,</span><span class=s1>&#39;$1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=nv>$version</span> <span class=o>-lt</span> <span class=p>(</span><span class=no>[Version]</span> <span class=s2>&#34;5.0&#34;</span><span class=p>))</span> <span class=p>{</span> <span class=nv>$_</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c># yields: 12/18/2020 7:50:33 AM</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li></ul></li><li><p><strong>Scenario II</strong>: The Security Team is using Event Logs more. They want to ensure they can monitor if event logs are cleared. You assigned a colleague to execute this action.</p><ul><li><img src="/write-ups/images/Pasted image 20220613024859.png" width=auto></li><li>A¬†<strong>Log clear</strong>¬†event was recorded. What is the &lsquo;Event Record ID&rsquo;? <code>27736</code></li><li>What is the name of the computer? <code>PC01.example.corp</code></li></ul></li><li><p><strong>Scenario III</strong>: The threat intel team shared its research on¬†<strong>Emotet</strong>. They advised searching for event ID 4104 and the text &ldquo;ScriptBlockText&rdquo; within the EventData element. Find the encoded PowerShell payload.</p><ul><li><img src="/write-ups/images/Pasted image 20220613030426.png" width=auto><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WinEvent</span> <span class=n>-Path</span> <span class=p>.\</span><span class=n>merged</span><span class=p>.</span><span class=n>evtx</span> <span class=n>-FilterXPath</span> <span class=s1>&#39;*/System/EventID=4104 and */EventData/Data[@Name=&#34;ScriptBlockText&#34;]&#39;</span> <span class=n>-Oldest</span> <span class=n>-MaxEntries</span> <span class=n>1</span> <span class=p>|</span> <span class=nb>Format-List</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li><li>What is the name of the first variable within the PowerShell command? <code>$Va5w3n8</code></li><li>What is the¬†<strong>Date and Time</strong>¬†this attack took place?¬†(<strong>MM/DD/YYYY H:MM:SS AM/PM</strong>): <code>8/25/2020 10:09:28</code></li><li>What is the¬†<strong>Execution Process ID</strong>? <code>6620</code></li></ul></li><li><p><strong>Scenario IV</strong>: A report came in that an intern was suspected of running unusual commands on her machine, such as enumerating members of the Administrators group. A senior analyst suggested searching for &ldquo;<code>C:\Windows\System32\net1.exe</code>&rdquo;. Confirm the suspicion</p><ul><li>What is the¬†<strong>Group Security ID</strong>¬†of the group she enumerated? <code>S-1-5-32-544</code></li><li>What is the event ID? <code>4799</code></li></ul></li></ul><hr><a href=#references><h2 id=references><span class=hanchor arialabel=Anchor># </span>References</h2></a><ul><li><a href=https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES rel=noopener>Windows Event Attack Samples</a></li><li><a href=https://devblogs.microsoft.com/powershell/powershell-the-blue-team/ rel=noopener>Powershell the bluee team</a></li><li><a href=https://blog.palantir.com/tampering-with-windows-event-tracing-background-offense-and-defense-4be7ac62ac63 rel=noopener>Tampering with Windows Event Tracing: Background, Offense, and Defense</a></li></ul><a href=#see-also><h2 id=see-also><span class=hanchor arialabel=Anchor># </span>See Also</h2></a><ul><li><a href=/write-ups/thm/sysinternals rel=noopener class=internal-link data-src=/write-ups/thm/sysinternals>write-ups/thm/sysinternals</a></li><li><a href=/write-ups/thm/core-windows-processes rel=noopener class=internal-link data-src=/write-ups/thm/core-windows-processes>write-ups/thm/core-windows-processes</a></li><li><a href=/write-ups/THM rel=noopener class=internal-link data-src=/write-ups/THM>write-ups/THM</a></li></ul></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li><a href=/write-ups/Cyber-Defense/ data-ctx=write-ups/thm/windows-event-logs data-src=/write-ups/Cyber-Defense class=internal-link>Cyber Defense</a></li><li><a href=/write-ups/thm/investigating-windows/ data-ctx=write-ups/thm/windows-event-logs data-src=/write-ups/thm/investigating-windows class=internal-link>Investigating Windows</a></li><li><a href=/write-ups/thm/sysmon/ data-ctx=write-ups/thm/windows-event-logs data-src=/write-ups/thm/sysmon class=internal-link>SysMon</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://hakbrain.xyz/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Vl@gh3 using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, ¬© 2022</p><ul><li><a href=https://hakbrain.xyz/>Home</a></li><li><a href=https://twitter.com/vlaghe1>Twitter</a></li><li><a href=https://github.com/vlagh3>Github</a></li></ul></footer></div></div></body></html>