<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Covers techniques to recover AD credentials in this network:
 NTLM Authenticated Services LDAP Bind Credentials Authentication Relays Microsoft Deployment Toolkit Configuration Files  We can use these techniques on a security assesment by targeting systems of an organisation that are internet-facing or by implanting a rogue device on the organisation&rsquo;s network"><title>Breaching Active Directory</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://hakbrain.xyz//icon.png><link href=https://hakbrain.xyz/styles.f40f9c8ac1c106641723dab5233fc67c.min.css rel=stylesheet><link href=https://hakbrain.xyz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://hakbrain.xyz/js/darkmode.8bfc78cc60cc5da6df81ec79c82c3775.min.js></script>
<script src=https://hakbrain.xyz/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://hakbrain.xyz/js/popover.abe6a51cc7138c5dff00f151dd627ad1.min.js></script>
<script src=https://hakbrain.xyz/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://hakbrain.xyz/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://hakbrain.xyz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://hakbrain.xyz/",fetchData=Promise.all([fetch("https://hakbrain.xyz/indices/linkIndex.e068852ac1d4c726f96843c25b8fe6a1.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://hakbrain.xyz/indices/contentIndex.a55941f836b3141bbde3293fea0e15e6.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://hakbrain.xyz",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://hakbrain.xyz",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/hakbrain.xyz\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://hakbrain.xyz/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://hakbrain.xyz/>üï∏Ô∏è H@kBr4in</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Breaching Active Directory</h1><p class=meta>Last updated
Sep 6, 2022
<a href=https://github.com/vlagh3/hakbrain/tree/hugo/content/write-ups/thm/breaching-active-directory.md rel=noopener>Edit Source</a></p><ul class=tags><li><a href=https://hakbrain.xyz/tags/writeups/>Writeups</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#osint>OSINT</a></li><li><a href=#phising>Phising</a></li><li><a href=#ntlm-authentication-services>NTLM Authentication Services</a><ol><li><a href=#password-spraying>Password Spraying</a></li></ol></li><li><a href=#ldap-blind-credentials>LDAP Blind Credentials</a><ol><li><a href=#ldap-pass-back>LDAP Pass-Back</a></li><li><a href=#rogue-ldap-server>Rogue LDAP server</a></li></ol></li><li><a href=#authentication-relays>Authentication Relays</a></li><li><a href=#microsoft-deployment-toolkit>Microsoft Deployment Toolkit</a><ol><li><a href=#pxe-boot>PXE Boot</a></li><li><a href=#exploitation>Exploitation</a></li></ol></li><li><a href=#configuration-files>Configuration Files</a></li><li><a href=#mitigation>Mitigation</a></li><li><a href=#references>References</a></li><li><a href=#see-also>See Also</a></li></ol></nav></details></aside><p>Covers techniques to recover AD credentials in this network:</p><ul><li>NTLM Authenticated Services</li><li>LDAP Bind Credentials</li><li>Authentication Relays</li><li>Microsoft Deployment Toolkit</li><li>Configuration Files</li></ul><p>We can use these techniques on a security assesment by targeting systems of an organisation that are internet-facing or by implanting a rogue device on the organisation&rsquo;s network</p><ul><li><strong>Setup</strong><ul><li>configure DNS by adding <code>DNS=&lt;THMDC IP></code> to the <code>/etc/systemd/resolved.conf</code>¬†file</li><li>save it & restart the service: <code>systemctl restart systemd-resolved</code></li><li>test modifications: <code>nslookup thmdc.za.tryhackme.com</code></li></ul></li></ul><a href=#osint><h2 id=osint><span class=hanchor arialabel=Anchor># </span>OSINT</h2></a><p><a rel=noopener class="internal-link broken" data-src=OSINT>OSINT</a> is used to disscover information online. In the case of AD this can happen for several reasons such as:</p><ul><li>Users who ask questions on public forums such as¬†
<a href=https://stackoverflow.com/ rel=noopener>Stack Overflow</a>¬†but disclose sensitive information such as their credentials in the question.</li><li>Developers that upload scripts to services such as¬†
<a href=https://github.com/ rel=noopener>Github</a>¬†with credentials hardcoded.</li><li>Credentials being disclosed in past breaches since employees used their work accounts to sign up for other external websites. Websites such as¬†
<a href=https://haveibeenpwned.com/ rel=noopener>HaveIBeenPwned</a>¬†and¬†
<a href=https://www.dehashed.com/ rel=noopener>DeHashed</a>¬†provide excellent platforms to determine if someone&rsquo;s information, such as work email, was ever involved in a publicly known data breach.</li></ul><p>A detailed room on Red Team OSINT can be found¬†
<a href=https://tryhackme.com/jr/redteamrecon rel=noopener>here.</a></p><a href=#phising><h2 id=phising><span class=hanchor arialabel=Anchor># </span>Phising</h2></a><p>Phishing¬†is another excellent method to breach AD. Phishing usually entices users to either provide their credentials on a malicious web page or ask them to run a specific application that would install a Remote Access Trojan (RAT) in the background. This is a prevalent method since the RAT would execute in the user&rsquo;s context, immediately allowing you to impersonate that user&rsquo;s AD account. This is why phishing is such a big topic for both Red and Blue teams.</p><p>A detailed room on phishing can be found¬†
<a href=https://tryhackme.com/module/phishing rel=noopener>here.</a></p><a href=#ntlm-authentication-services><h2 id=ntlm-authentication-services><span class=hanchor arialabel=Anchor># </span>NTLM Authentication Services</h2></a><ul><li>[New Technology LAN Manager (NTLM)](New Technology LAN Manager (NTLM)) is the suite of security protocols used to authenticate users&rsquo; identities in [AD](../../sheets/Active Directory.md)</li><li>services that use NetNTLM can also be exposed to the internet. The following are some of the popular examples:<ul><li>Internally-hosted Exchange (Mail) servers that expose an Outlook Web App (OWA) login portal.</li><li>Remote Desktop Protocol (RDP) service of a server being exposed to the internet.</li><li>Exposed VPN endpoints that were integrated with AD.</li><li>Web applications that are internet-facing and make use of NetNTLM</li></ul></li><li>allows the application to play the role of a middle man between the client and AD. All authentication is forwarded to the [AD &ndash; Domain Controllers (DC)](../../sheets/AD &ndash; Domain Controllers (DC).md) in the form of a challenge which will authenticate the user<ul><li><img src="/write-ups/images/Pasted image 20220618195656.png" width=auto></li><li>it prevents the application from storing AD credentials, which should only be stored on a Domain Controller</li></ul></li></ul><a href=#password-spraying><h3 id=password-spraying><span class=hanchor arialabel=Anchor># </span>Password Spraying</h3></a><ul><li>since most AD envs have account lockout configured, we won&rsquo;t be able to run a full brute-force attack</li><li>instead of trying multiple different passwords <em>(which will trigger an alert/account lockout)</em> we choose 1 passwoird and attempt to authenticate with all the usernames acquired</li></ul><blockquote><p><strong>NOTE</strong>: ¬†these types of attacks can be detected due to the amount of failed authentication attempts they will generate</p></blockquote><ul><li>we&rsquo;re provided with a list of usernames discovered during a red team OSINT exercise<ul><li>also indicated the organisation&rsquo;s initial onboarding password: <code>Changeme123</code></li></ul></li><li>we&rsquo;re gonna use a simple python script to try the default password for all users @ the web app <em>(
<a href=http://ntlmauth.za.tryhackme.com/ rel=noopener>http://ntlmauth.za.tryhackme.com</a>)</em></li></ul><a href=#ldap-blind-credentials><h2 id=ldap-blind-credentials><span class=hanchor arialabel=Anchor># </span>LDAP Blind Credentials</h2></a><ul><li>another method of AD authentication that applications can use is Lightweight Directory Access Protocol (LDAP) authentication</li><li>similar to NTLM authentication, but the application directly verifies the user&rsquo;s creds<ul><li>has a pair of AD creds that it can use to query LDAP & verify</li></ul></li><li>popular mechanism amongst third-party (non-Microsoft) applications that integrate with AD <em>(e.g Gitlab, Jenkins, custom web-apps, printers, VPNs)</em></li><li>process of authentication through LDAP:<ul><li><img src=https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/d2f78ae2b44ef76453a80144dac86b4e.png width=auto alt></li></ul></li><li>can use the same typee of attacks as those leveraged against NTLM, however, since LDAP auth requires a set of AD credentials, it opens up additional attack avenues<ul><li>we can attempt to recover the AD credentials used by the service to gain authenticated access to AD</li><li>once you gain a foothold on the correct host, such as a Gitlab server, it might be as simple as reading the configuration files to recover these AD credentials</li></ul></li></ul><a href=#ldap-pass-back><h3 id=ldap-pass-back><span class=hanchor arialabel=Anchor># </span>LDAP Pass-Back</h3></a><ul><li>can be performed when already have access to device&rsquo;s configuration <em>(e.g printer with default creds)</em></li><li>then we alter the LDAP conf such as the IP or hostname of the device is redirected to our machine so we can intercept the authentication attempt & recover the credentials</li><li>we have an interesting endpoint @ <code>http://printer.za.tryhackme.com/settings</code><ul><li><img src="/write-ups/images/Pasted image 20220619004402.png" width=auto></li></ul></li><li>can redirect to our ip adddr & try to catch the auth req: <code>nc -nvlp 389</code><ul><li><img src="/write-ups/images/Pasted image 20220619004119.png" width=auto></li><li><code>suppportedCapabilities</code> indicates that we have a problem</li><li>before the printer sends the creds, it&rsquo;s trying to negotiaate the LDAP auth method details => will select the most secure authentication method that both the printer and the LDAP server support</li><li>depending on the auth method used the creds will not be sent over in cleartext <em>(in some casess they&rsquo;ll not be transmitted over the network @ all)</em></li></ul></li></ul><a href=#rogue-ldap-server><h3 id=rogue-ldap-server><span class=hanchor arialabel=Anchor># </span>Rogue LDAP server</h3></a><ul><li>install requirments<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt-get update <span class=o>&amp;&amp;</span> sudo apt-get -y install slapd ldap-utils <span class=o>&amp;&amp;</span> sudo systemctl <span class=nb>enable</span> slapd
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li><li>reconfigure ldap server: <code>sudo dpkg-reconfigure -p low slapd</code><ul><li>domain name & organizaation name: <code>za.tryhackme.com</code></li><li>remove db when slapd purged: no</li><li>move old database: yes</li></ul></li><li>downgrade the supported auth mechanisms to only <code>PLAIN</code> & <code>LOGIN</code> from <code>olcSaslSecProps.ldif</code><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>dn: cn=config 
</span></span><span class=line><span class=cl>replace: olcSaslSecProps 
</span></span><span class=line><span class=cl>olcSaslSecProps: noanonymous,minssf=0,passcred
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li><li>patch our LDAP server config from the above file: <code>sudo ldapmodify -Y EXTERNAL -H ldapi:// -f ./olcSaslSecProps.ldif && sudo service slapd restart</code></li><li>verify if everything&rsquo;s good<ul><li><img src="/write-ups/images/Pasted image 20220619021230.png" width=auto></li></ul></li><li>capture ldap credentials: <code>tcpdump -SX -i tun0 tcp port 389 -w ldap_pass -vv</code></li><li>go to <code>http://printer.za.tryhackme.com/settings</code> & send LDAP auth</li><li><img src="/write-ups/images/Pasted image 20220619021410.png" width=auto></li></ul><a href=#authentication-relays><h2 id=authentication-relays><span class=hanchor arialabel=Anchor># </span>Authentication Relays</h2></a><ul><li>setup
<a href=https://github.com/lgandx/Responder rel=noopener>responder</a>: <code>responder -I tun0</code> A<ul><li><img src="/write-ups/images/Pasted image 20220619025323.png" width=auto></li></ul></li><li>crack the hash: <code>hashcat -m 5600 svcFileCopy_hash passwordlist.txt</code><ul><li><img src="/write-ups/images/Pasted image 20220619025204.png" width=auto></li></ul></li></ul><a href=#microsoft-deployment-toolkit><h2 id=microsoft-deployment-toolkit><span class=hanchor arialabel=Anchor># </span>Microsoft Deployment Toolkit</h2></a><ul><li>Microsoft Deployment Toolkit (MDT) is a Microsoft service that assists with automating the deployment of Microsoft Operating Systems (OS)</li><li>large organizations use MDT to deploy new images in their esstate more efficiently since the base images can be maintained & updated in a central location</li><li>usually MDT is integrated with Microsoft&rsquo;s System Center Configuration Manager <em>(SCCM)</em>: which manages all updates for all Microsoft applications, services, and operating systems<ul><li>allows the IT team to preconfigure and manage boot images</li><li>when a new machine needs configuration, just plug in the network & everything happens automatically <em>(e.g install Office365 & AV of choice)</em></li></ul></li><li>SCCM can be seen as almost an expansion and the big brother to MDT<ul><li>once the software is installed, SSCM does this type of patch management</li><li>allows the IT team to review available updates to all software installed across the estate</li><li>can also test these patches in a sandbox environment to ensure they are stable before centrally deploying them to all domain-joined machines</li></ul></li></ul><a href=#pxe-boot><h3 id=pxe-boot><span class=hanchor arialabel=Anchor># </span>PXE Boot</h3></a><ul><li>Use PXE boot to allow new devices that are connected to the network to load and install the¬†OS¬†directly over a network connection</li><li>usually integrated with DHCP, which means that if DHCP assigns an IP lease, the host is allowed to request the PXE boot image and start the network OS installation process. Communication flow is shown below<ul><li><img src="/write-ups/images/Pasted image 20220619025535.png" width=auto></li></ul></li><li>once that&rsquo;s finished the client will use a TFTP connection to download the PXE boot image</li><li>this is quite often targeted by adveraries since one can:<ul><li>inject a privilege escalation vector, such as a Local Administrator account, to gain Administrative access to the¬†OS¬†once the PXE boot has been completed</li><li>perform password scraping attacks to recover AD credentials used during the install</li></ul></li></ul><a href=#exploitation><h3 id=exploitation><span class=hanchor arialabel=Anchor># </span>Exploitation</h3></a><a href=#configuration-files><h2 id=configuration-files><span class=hanchor arialabel=Anchor># </span>Configuration Files</h2></a><ul><li>configuration files are an excellent avenue to explore in an attempt to recover AD credentials. Depending on the host that was breached, various configuration files may be of value for enumeration <em>(e.g webapp, service, registry keys, centrally deployed apps)</em></li><li>several enumeration scripts, such as¬†
<a href=https://github.com/GhostPack/Seatbelt rel=noopener>Seatbelt</a>, can be used to automate this process.</li><li>sql enumeration:<ul><li><img src="/write-ups/images/Pasted image 20220619041116.png" width=auto><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>AGENT_PROXY_CONFIG</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>PROXY_USAGE</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>BYPASS_LOCAL</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>ALLOW_USER_CONFIG</span><span class=w> </span><span class=nb>INTEGER</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>EXCLUSION_LIST</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>SYSTEM_PROXY_HTTP_AUTH_REQD</span><span class=w> </span><span class=nb>INTEGER</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>SYSTEM_PROXY_HTTP_USER</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>SYSTEM_PROXY_HTTP_PASSWD</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>SYSTEM_PROXY_FTP_AUTH_REQD</span><span class=w> </span><span class=nb>INTEGER</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>SYSTEM_PROXY_FTP_USER</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>SYSTEM_PROXY_FTP_PASSWD</span><span class=w> </span><span class=nb>TEXT</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=n>PROXY_USAGE</span><span class=p>,</span><span class=w> </span><span class=n>BYPASS_LOCAL</span><span class=p>,</span><span class=w> </span><span class=n>ALLOW_USER_CONFIG</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>ON</span><span class=w> </span><span class=n>CONFLICT</span><span class=w> </span><span class=k>REPLACE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></td></tr></table></div></div></li><li><img src="/write-ups/images/Pasted image 20220619041608.png" width=auto></li></ul></li><li><img src="/write-ups/images/Pasted image 20220619052118.png" width=auto></li></ul><a href=#mitigation><h2 id=mitigation><span class=hanchor arialabel=Anchor># </span>Mitigation</h2></a><ul><li><strong>User awareness and training</strong> - The weakest link in the cybersecurity chain is almost always users. Training users and making them aware that they should be careful about disclosing sensitive information such as credentials and not trust suspicious emails reduces this attack surface.</li><li><strong>Limit the exposure of AD services and applications online</strong> - Not all applications must be accessible from the internet, especially those that support NTLM and LDAP authentication. Instead, these applications should be placed in an intranet that can be accessed through a VPN. The VPN can then support multi-factor authentication for added security.</li><li><strong>Enforce Network Access Control (NAC)</strong> - NAC can prevent attackers from connecting rogue devices on the network. However, it will require quite a bit of effort since legitimate devices will have to be allowlisted.</li><li><strong>Enforce SMB Signing</strong> - By enforcing SMB signing, SMB relay attacks are not possible.</li><li><strong>Follow the principle of least privileges</strong> - In most cases, an attacker will be able to recover a set of AD credentials. By following the principle of least privilege, especially for credentials used for services, the risk associated with these credentials being compromised can be significantly reduced.</li></ul><hr><a href=#references><h2 id=references><span class=hanchor arialabel=Anchor># </span>References</h2></a><ul><li><a href=https://www.riskinsight-wavestone.com/en/2020/01/taking-over-windows-workstations-pxe-laps/ rel=noopener>Taking over Windows Workstations thanks to LAPS and PXE</a></li></ul><a href=#see-also><h2 id=see-also><span class=hanchor arialabel=Anchor># </span>See Also</h2></a><ul><li><a href=/write-ups/THM rel=noopener class=internal-link data-src=/write-ups/THM>write-ups/THM</a></li></ul></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://hakbrain.xyz/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Vl@gh3 using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, ¬© 2022</p><ul><li><a href=https://hakbrain.xyz/>Home</a></li><li><a href=https://twitter.com/vlaghe1>Twitter</a></li><li><a href=https://github.com/vlagh3>Github</a></li></ul></footer></div></div></body></html>