<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Description: You and your buddy corrected the math in your physics teacher&rsquo;s paper on the decay of highly excited massive string states in the footnote of a renowned publication."><title>Breaking Grad</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://hakbrain.xyz//icon.png><link href=https://hakbrain.xyz/styles.f40f9c8ac1c106641723dab5233fc67c.min.css rel=stylesheet><link href=https://hakbrain.xyz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://hakbrain.xyz/js/darkmode.8bfc78cc60cc5da6df81ec79c82c3775.min.js></script>
<script src=https://hakbrain.xyz/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://hakbrain.xyz/js/popover.abe6a51cc7138c5dff00f151dd627ad1.min.js></script>
<script src=https://hakbrain.xyz/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://hakbrain.xyz/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://hakbrain.xyz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://hakbrain.xyz/",fetchData=Promise.all([fetch("https://hakbrain.xyz/indices/linkIndex.5b01dfba4be75fb390be0344cfee4347.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://hakbrain.xyz/indices/contentIndex.df05281a04316d10c733a2b9de3af96e.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://hakbrain.xyz",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://hakbrain.xyz",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/hakbrain.xyz\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://hakbrain.xyz/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://hakbrain.xyz/>üï∏Ô∏è H@kBr4in</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Breaking Grad</h1><p class=meta>Last updated
Mar 19, 2023
<a href=https://github.com/vlagh3/hakbrain/tree/hugo/content/write-ups/htb/BreakingGrad.md rel=noopener>Edit Source</a></p><ul class=tags><li><a href=https://hakbrain.xyz/tags/writeups/>Writeups</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#code-analysis>Code Analysis</a><ol><li><a href=#objecthelper>ObjectHelper</a></li><li><a href=#debughelper>DebugHelper</a></li></ol></li><li><a href=#exploitation>Exploitation</a><ol><li><a href=#prototype-pollution-poc>Prototype Pollution POC</a></li><li><a href=#chain-for-rce>Chain for RCE</a></li></ol></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#refs>Refs</a></li><li><a href=#see-also>See Also</a></li></ol></nav></details></aside><p><strong>Description</strong>: You and your buddy corrected the math in your physics teacher&rsquo;s paper on the decay of highly excited massive string states in the footnote of a renowned publication. He&rsquo;s just failed your thesis out of spite, for making a fool out of him in the university&rsquo;s research symposium. Now you can&rsquo;t graduate, unless you can do something about it&mldr; ü§∑</p><p>Visiting the webpage there&rsquo;s not much going on, just a button that checks if we passed</p><p><img src="/write-ups/images/Pasted image 20230319091728.png" width=auto></p><p>Intercepting the traffic with burp it&rsquo;s revealing that the logic behind checking if we passed or not is made with a <code>POST</code> to <code>/api/calculate/</code>:</p><p><img src="/write-ups/images/Pasted image 20230319091928.png" width=auto></p><p>We can try messing with the <code>name</code> value, but before doing anything else let&rsquo;s look @ the source code provided by the challenge</p><a href=#code-analysis><h2 id=code-analysis><span class=hanchor arialabel=Anchor># </span>Code Analysis</h2></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/debug/:action&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>DebugHelper</span><span class=p>.</span><span class=nx>execute</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>params</span><span class=p>.</span><span class=nx>action</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>router</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;/api/calculate&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>student</span> <span class=o>=</span> <span class=nx>ObjectHelper</span><span class=p>.</span><span class=nx>clone</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>StudentHelper</span><span class=p>.</span><span class=nx>isDumb</span><span class=p>(</span><span class=nx>student</span><span class=p>.</span><span class=nx>name</span><span class=p>)</span> <span class=o>||</span> <span class=o>!</span><span class=nx>StudentHelper</span><span class=p>.</span><span class=nx>hasBase</span><span class=p>(</span><span class=nx>student</span><span class=p>.</span><span class=nx>paper</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;pass&#39;</span><span class=o>:</span> <span class=s1>&#39;n&#39;</span> <span class=o>+</span> <span class=nx>randomize</span><span class=p>(</span><span class=s1>&#39;?&#39;</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=p>{</span><span class=nx>chars</span><span class=o>:</span> <span class=s1>&#39;o0&#39;</span><span class=p>})</span> <span class=o>+</span> <span class=s1>&#39;pe&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;pass&#39;</span><span class=o>:</span> <span class=s1>&#39;Passed&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>/debug/:action</code> - stands out since it&rsquo;s something for developers. It takes the action provided by us & executes with with <code>DebugHelper</code></li><li><code>/api/calculate</code> - is using an <code>ObjectHelper</code> class with our <code>POST</code> body and creates a student Object which is further checked:<ul><li><code>isDumb()</code> - checks if <code>student.name</code> includes <code>"Baker" or "Purvis"</code></li><li><code>hasBase()</code> - an additional <code>paper</code> key is provided & it just checks if the <code>grade >= 10</code></li></ul></li></ul><p>So in order for us to pass we need to just provide a name different than the one&rsquo;s checked and add an additional key-val pair:</p><p><img src="/write-ups/images/Pasted image 20230319093044.png" width=auto></p><p>However that doesn&rsquo;t really help us much so let&rsquo;s take a deeper look @ <code>ObjectHelper</code> and <code>DebugHelper</code></p><a href=#objecthelper><h3 id=objecthelper><span class=hanchor arialabel=Anchor># </span>ObjectHelper</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// ObjectHelper.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>isObject</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>typeof</span> <span class=nx>obj</span> <span class=o>===</span> <span class=s1>&#39;function&#39;</span> <span class=o>||</span> <span class=k>typeof</span> <span class=nx>obj</span> <span class=o>===</span> <span class=s1>&#39;object&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>isValidKey</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>key</span> <span class=o>!==</span> <span class=s1>&#39;__proto__&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>merge</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>source</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>key</span> <span class=k>in</span> <span class=nx>source</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>isValidKey</span><span class=p>(</span><span class=nx>key</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>isObject</span><span class=p>(</span><span class=nx>target</span><span class=p>[</span><span class=nx>key</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=nx>isObject</span><span class=p>(</span><span class=nx>source</span><span class=p>[</span><span class=nx>key</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>this</span><span class=p>.</span><span class=nx>merge</span><span class=p>(</span><span class=nx>target</span><span class=p>[</span><span class=nx>key</span><span class=p>],</span> <span class=nx>source</span><span class=p>[</span><span class=nx>key</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>target</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=o>=</span> <span class=nx>source</span><span class=p>[</span><span class=nx>key</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>target</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>clone</span><span class=p>(</span><span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>merge</span><span class=p>({},</span> <span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The <code>clone</code> function simply merges our request body to an empty js object. It loops through all properties of our request body. If the property is an object or function it will overwrite the empty object&rsquo;s original implementation. Otherwise it will populate the empty object.</p><p>Note the <code>isValidKey</code> function, which checks if the key is <code>__proto__</code>. Hmm&mldr; this is hinting us that the developer is trying to prevent a
<a href=https://portswigger.net/web-security/prototype-pollution rel=noopener>prototype pollution vulnerability</a>. Despite his attempts we might be able to bypass it by using
<a href=https://book.hacktricks.xyz/pentesting-web/deserialization/nodejs-proto-prototype-pollution#prototype-pollution rel=noopener>alternatives</a> such as <code>prototype</code> or <code>constructor.prototype</code></p><a href=#debughelper><h3 id=debughelper><span class=hanchor arialabel=Anchor># </span>DebugHelper</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// DebugHelper.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>execute</span><span class=p>(</span><span class=nx>res</span><span class=p>,</span> <span class=nx>command</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>res</span><span class=p>.</span><span class=nx>type</span><span class=p>(</span><span class=s1>&#39;txt&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nx>command</span> <span class=o>==</span> <span class=s1>&#39;version&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>let</span> <span class=nx>proc</span> <span class=o>=</span> <span class=nx>fork</span><span class=p>(</span><span class=s1>&#39;VersionCheck.js&#39;</span><span class=p>,</span> <span class=p>[],</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>stdio</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;ignore&#39;</span><span class=p>,</span> <span class=s1>&#39;pipe&#39;</span><span class=p>,</span> <span class=s1>&#39;pipe&#39;</span><span class=p>,</span> <span class=s1>&#39;ipc&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>proc</span><span class=p>.</span><span class=nx>stderr</span><span class=p>.</span><span class=nx>pipe</span><span class=p>(</span><span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=nx>proc</span><span class=p>.</span><span class=nx>stdout</span><span class=p>.</span><span class=nx>pipe</span><span class=p>(</span><span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> 
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nx>command</span> <span class=o>==</span> <span class=s1>&#39;ram&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>execSync</span><span class=p>(</span><span class=s1>&#39;free -m&#39;</span><span class=p>).</span><span class=nx>toString</span><span class=p>());</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s1>&#39;invalid command&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// VersionCheck.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=kr>package</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;./package.json&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>nodeVersion</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>version</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=kr>package</span><span class=p>.</span><span class=nx>nodeVersion</span> <span class=o>==</span> <span class=nx>nodeVersion</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`Everything is OK (</span><span class=si>${</span><span class=kr>package</span><span class=p>.</span><span class=nx>nodeVersion</span><span class=si>}</span><span class=sb> == </span><span class=si>${</span><span class=nx>nodeVersion</span><span class=si>}</span><span class=sb>)`</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`You are using a different version of nodejs (</span><span class=si>${</span><span class=kr>package</span><span class=p>.</span><span class=nx>nodeVersion</span><span class=si>}</span><span class=sb> != </span><span class=si>${</span><span class=nx>nodeVersion</span><span class=si>}</span><span class=sb>)`</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>We basically have 2 commands:</p><ul><li><code>/debug/version</code>: uses
<a href=https://nodejs.org/api/child_process.html#child_processforkmodulepath-args-options rel=noopener>fork</a> to check our node version & return it to the user</li><li><code>/debug/ram</code>: executes <code>free -m</code> and returns it&rsquo;s output</li></ul><p>Trying to navigate to <code>/debug/ram</code> throws an error, telling us that the <code>free</code> command does not exist. However, <code>/debug/version</code> works</p><p><img src="/write-ups/images/Pasted image 20230319095351.png" width=auto></p><a href=#exploitation><h2 id=exploitation><span class=hanchor arialabel=Anchor># </span>Exploitation</h2></a><a href=#prototype-pollution-poc><h3 id=prototype-pollution-poc><span class=hanchor arialabel=Anchor># </span>Prototype Pollution POC</h3></a><p>Let&rsquo;s play with the prototype pollution locally first. I added a <code>/static/js/poc.js</code> file containing our <code>merge</code> with more logging so that we can play with it in the browser</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// poc.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>isObject</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>typeof</span> <span class=nx>obj</span> <span class=o>===</span> <span class=s1>&#39;function&#39;</span> <span class=o>||</span> <span class=k>typeof</span> <span class=nx>obj</span> <span class=o>===</span> <span class=s1>&#39;object&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>isValidKey</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>key</span> <span class=o>!==</span> <span class=s1>&#39;__proto__&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>merge</span><span class=p>(</span><span class=nx>target</span><span class=p>,</span> <span class=nx>source</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>key</span> <span class=k>in</span> <span class=nx>source</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>isValidKey</span><span class=p>(</span><span class=nx>key</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>                <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;VALID&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>isObject</span><span class=p>(</span><span class=nx>target</span><span class=p>[</span><span class=nx>key</span><span class=p>])</span> <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=nx>isObject</span><span class=p>(</span><span class=nx>source</span><span class=p>[</span><span class=nx>key</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>this</span><span class=p>.</span><span class=nx>merge</span><span class=p>(</span><span class=nx>target</span><span class=p>[</span><span class=nx>key</span><span class=p>],</span> <span class=nx>source</span><span class=p>[</span><span class=nx>key</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>                    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;target[key]: &#39;</span><span class=p>,</span> <span class=nx>target</span><span class=p>[</span><span class=nx>key</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>                    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;target: &#39;</span><span class=p>,</span> <span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;END IF&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;ELSE&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=nx>target</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=o>=</span> <span class=nx>source</span><span class=p>[</span><span class=nx>key</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;target[key]: &#39;</span><span class=p>,</span> <span class=nx>target</span><span class=p>[</span><span class=nx>key</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>                    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;target: &#39;</span><span class=p>,</span> <span class=nx>target</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>target</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// index.html
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>&lt;</span><span class=nx>script</span> <span class=nx>src</span><span class=o>=</span><span class=s1>&#39;/static/js/poc.js&#39;</span> <span class=nx>type</span><span class=o>=</span><span class=s1>&#39;text/javascript&#39;</span><span class=o>&gt;&lt;</span><span class=err>/script&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>Now we can start playing</p><p><img src="/write-ups/images/Pasted image 20230319100424.png" width=auto></p><p>The empty object was indeed populated with the new provided one. Every object in JavaScript is linked to another object of some kind, known as its
<a href=https://portswigger.net/web-security/prototype-pollution/javascript-prototypes-and-inheritance rel=noopener>prototype</a></p><p><img src=/write-ups/images/prototype-pollution-prototype-chain.svg width=auto></p><p>This can be accessed with an built-in property <code>__proto__</code> which refers to the constructor of the object & serves as both a getter and setter for the object&rsquo;s prototype. Even if it&rsquo;s filtered we can use <code>constructor.prototype</code> which will refer to the same thing.</p><p>In our example the constructor for our empty object <code>{}</code> is the <code>Object</code> function. Appending a property to the <code>Object</code>&rsquo;s prototype will make all existing and new objects contain this property inherited</p><p><img src="/write-ups/images/Pasted image 20230319102110.png" width=auto></p><a href=#chain-for-rce><h3 id=chain-for-rce><span class=hanchor arialabel=Anchor># </span>Chain for RCE</h3></a><p>Ok so we can add properties to all objects, but how can we leverage this to gain RCE. A good place to start would be <a class="internal-link broken"></a> since it has 2 functions executing code <code>fork</code> and <code>execSync</code>. Notice that an object literal is passed into the <code>fork</code> function, meaning that our polluted values/keys will be present. Looking at the
<a href=https://nodejs.org/api/child_process.html#child_processforkmodulepath-args-options rel=noopener>docs</a> we find that it accepts an <code>execPath</code> and <code>execArgv</code> as parameters</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>execPath¬†&lt;string&gt;¬†Executable used to create the child process.
</span></span><span class=line><span class=cl>execArgv¬†<span class=o>[</span>&lt;string<span class=o>[]</span>&gt;List of string arguments passed to the executable.¬†Default:¬†process.execArgv
</span></span></code></pre></td></tr></table></div></div><p>Modifying our payload to pollute these, we can gain RCE</p><p><img src="/write-ups/images/Pasted image 20230319103205.png" width=auto></p><p><img src="/write-ups/images/Pasted image 20230319103220.png" width=auto></p><a href=#conclusion><h2 id=conclusion><span class=hanchor arialabel=Anchor># </span>Conclusion</h2></a><p>I&rsquo;ve went into this challenge quite blindly, knowing about prototype pollution only from posts online. Going through the material provided by
<a href=https://portswigger.net/web-security/prototype-pollution rel=noopener>portswigger Web Academy</a> definitely made me fully grasp what I was attacking and how javascript works under the hood which helped clear the path of how should I approach this challenge.</p><p>Thanks for reading, stay curios and keep it fun
EvBit out.</p><a href=#refs><h2 id=refs><span class=hanchor arialabel=Anchor># </span>Refs</h2></a><ul><li><a href=https://portswigger.net/web-security/prototype-pollution rel=noopener>what is prototype pollution</a></li><li><a href=https://portswigger.net/web-security/prototype-pollution/javascript-prototypes-and-inheritance rel=noopener>javascript prototypes and inheritaance</a></li><li><a href=https://book.hacktricks.xyz/pentesting-web/deserialization/nodejs-proto-prototype-pollution rel=noopener>haktricks prototype pollution</a></li></ul><a href=#see-also><h2 id=see-also><span class=hanchor arialabel=Anchor># </span>See Also</h2></a><ul><li><a href=/write-ups/HTB rel=noopener class=internal-link data-src=/write-ups/HTB>write-ups/HTB</a></li></ul></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://hakbrain.xyz/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Vl@gh3 using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, ¬© 2023</p><ul><li><a href=https://hakbrain.xyz/>Home</a></li><li><a href=https://twitter.com/vlaghe1>Twitter</a></li><li><a href=https://github.com/vlagh3>Github</a></li></ul></footer></div></div></body></html>